<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lee Man Youth Academy Player Review Generator</title>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
	<script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.min.js"></script>
	<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />	
   	<!-- For A4 paper printing -->
    <style>
    @media print {
        @page {
            size: A4 portrait;
            margin: 0.5cm;
        }
        html, body {
            height: auto !important;
            overflow: visible !important;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
            color-adjust: exact;
            margin: 0;
            background-color: white;
			font-size: 9pt; /* Slightly smaller font to fit more content */
        }
        .no-print, .hide-for-print, .print-back-btn { 
            display: none !important; 
        }
        .page-break { 
            page-break-before: always !important; 
            break-before: page !important;
            display: block !important;
            height: 0 !important;
            clear: both !important;
        }

		#report-container {
			width: 100% !important;
			max-width: 19cm !important; /* Match the preview’s max-width */
			max-height: none; /* Fits A4 height per page */
			padding: 0.2cm !important; /*reduced padding from 0.5*/
			margin: 0 auto !important;
			box-sizing: border-box !important;
			height: auto !important;
			overflow: visible !important; /* prevent content overflow, changed from visible */
		}

        #app-container {
            display: none !important; 
        }
		#print-container {
			display: block !important;
			position: static !important;
			width: 100% !important;
			max-width: 19cm !important;
			height: auto !important;
			max-height: none; /* Constrain to A4 height */
			overflow: visible !important; /* Prevent overflow */
			background: white !important;
			z-index: auto !important;
			padding: 0 !important;
			margin: 0 auto !important;
			box-sizing: border-box !important;

        }
		.grid-2x2, .grid.grid-cols-1.md\:grid-cols-2 {
			grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
			gap: 0.3rem !important; /* Reduced gap to save space */
		}
		*, *::before, *::after {
			box-sizing: border-box !important;
			-webkit-box-sizing: border-box !important; /* Safari fix */
		}
        
        /* Ensure headings don't get separated from their content */
		h1, h2, h3, h4, h5, h6 {
			page-break-after: avoid !important;
			break-after: avoid !important;
			page-break-inside: avoid !important;
			break-inside: avoid !important;
			font-size: 85% !important; /* Slightly reduce heading size */
			margin: 0.3cm 0 !important; /* Reduced margins */
		}
        
        /* General layout fixes */
        .print-section {
            page-break-inside: avoid !important;
            break-inside: avoid !important;
			max-height: 24cm !important; /* Ensure sections fit within page */
			overflow: hidden !important;
			margin-bottom: 0.2cm !important;
        }
        
        .print-section-break {
            page-break-before: always !important;
            break-before: always !important;
        }
        
        /* Explicitly allow these to break across pages */
        .print-allow-break {
            page-break-inside: auto !important;
            break-inside: auto !important;
        }
        
        /* Signature section */
		.signature-section {
			page-break-before: auto !important;
			break-before: auto !important;
			margin-top: 2cm !important; /* keep if you like the vertical gap */
			max-height: none !important; /* allow full height */
			font-size: 9pt !important;   /* or remove this line entirely */
		  }

        
        /* Force image rendering */
        img {
			display: block !important;
			max-width: 100% !important;
			width: auto !important;
			height: auto !important;
			page-break-inside: avoid !important;
			break-inside: avoid !important;
		}
		/* Safari-specific fixes */
		@supports (-webkit-hyphens: none) {
			#report-container, #print-container {
				-webkit-transform: scale(0.95); /* Additional scaling for Safari */
				-webkit-box-sizing: border-box;
				overflow: hidden !important;
			}
			table, tr, td, th {
				page-break-inside: avoid !important;
				break-inside: avoid !important;
			}
		}
    }

    /* Screen-specific adjustments for print mode */
    .print-mode #app-container {
        display: none !important;
    }
    .print-mode #print-container {
        display: block !important;
        position: fixed !important;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: white;
        z-index: 9999;
        overflow: auto;
        padding: 0.5cm !important;
    }
    /* Ensure Back to Editor button is styled */
    .print-back-btn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 10px 20px;
        background-color: #FFD700;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }
    .print-mode .print-back-btn {
        display: block !important; /* Ensure visibility in print mode */
    }
	.shadow-custom {
		box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
	  }
	  
	 /* Custom slider styles */
	input[type="range"] {
		-webkit-appearance: none; /* Remove default styling */
		appearance: none;
		width: 100%;
		height: 8px; /* Slightly thicker track */
		background: rgba(255, 215, 0, 0.2); /* bg-primary/20 */
		border-radius: 9999px; /* rounded-full */
		outline: none;
		transition: box-shadow 0.2s ease; /* Smooth transition for hover */
	}

	input[type="range"]:hover {
		box-shadow: 0 0 10px rgba(255, 215, 0, 0.5); /* hover:shadow-md equivalent with primary color glow */
	}

	input[type="range"]::-webkit-slider-thumb {
		-webkit-appearance: none;
		appearance: none;
		width: 16px;
		height: 16px;
		background: #FFD700; /* bg-primary */
		border-radius: 50%; /* rounded-full */
		cursor: pointer;
		border: none;
	}

	input[type="range"]::-moz-range-thumb {
		width: 16px;
		height: 16px;
		background: #FFD700; /* bg-primary */
		border-radius: 50%;
		cursor: pointer;
		border: none;
	}

	input[type="range"]::-ms-thumb {
		width: 16px;
		height: 16px;
		background: #FFD700; /* bg-primary */
		border-radius: 50%;
		cursor: pointer;
		border: none;
	}
		
	.progress-fill {
        animation: progress 1s ease-in-out;
    }
	.status-icon {
		display: inline-block;
		width: 1em;
		text-align: center;
		color: #ef4444; /* Red for incomplete */
	}
	.status-icon.completed {
		color: #10b981; /* Green for complete */
	}
	.collapsible-header {
		cursor: pointer;
		display: flex;
		justify-content: space-between;
		align-items: center;
		padding: 0.5rem 1rem;
		background-color: #f9fafb;
		border-radius: 0.5rem;
		transition: background-color 0.2s ease;
	}
	.collapsible-header:hover {
		background-color: #e5e7eb;
	}
	.collapsible-content {
		display: none;
		padding: 1rem;
	}
	.collapsible-content.active {
		display: block;
	}
	.toggle-icon::before {
		content: '+';
		font-size: 1.25rem;
		color: #FFD700;
	}
	.collapsible-header.active .toggle-icon::before {
		content: '−';
	}
	.required-field {
		border-color: #ef4444; /* Red border for empty required fields */
	}
	.required-field.valid {
		border-color: #10b981; /* Green border when filled */
	}
	.disabled-btn {
		background-color: #6b7280; /* Tailwind's gray-500 */
		color: #d1d5db; /* Tailwind's gray-300 */
		cursor: not-allowed;
		opacity: 1; /* Remove the opacity fade */
	}
    @keyframes progress {
        from { width: 0%; }
        to { width: var(--progress-width); }
    }
    .border:hover {
        transform: translateY(-2px);
        transition: transform 0.2s ease;
    }
	.dark .text-gray-600 {
	  color: #d1d5db; /* Tailwind's text-gray-300 */
	}
	.dark .text-gray-500 {
	  color: #9ca3af; /* Tailwind's text-gray-400 */
	}
	.dark input::placeholder,
	.dark textarea::placeholder {
	  color: #d1d5db; /* Matches text-gray-300 */
	}

	.dark .collapsible-content .border {
	  border-color: #4b5563; /* Tailwind's gray-600 for better visibility */

	}
	.dark #progress-tracker .collapsible-header {
		background-color: #374151 !important; /* Tailwind's gray-800 */
	}
	.dark #progress-tracker .collapsible-header:hover {
		background-color: #4b5563 !important; /* Tailwind's gray-700 */
	}
	.dark .collapsible-header {
		background-color: #374151 !important;
	}
	.dark .collapsible-header:hover {
		background-color: #4b5563 !important;
	}
	/* Change the font color of collapsible header text to gold in dark mode */
	.dark .collapsible-header h2,
	.dark .collapsible-header h3 {
		color: #FFD700;
	}
	/* Ensure the collapsible header in dark mode has the correct background */
	.dark #progress-tracker .collapsible-header {
		background-color: #374151; /* Tailwind's gray-800 */
	}
	.dark #progress-tracker .collapsible-header:hover {
		background-color: #4b5563; /* Tailwind's gray-700 */
	}
	/* Progress Bar Styles */
	.progress-bar-container {
		width: 100%;
	}
	.progress-bar {
		width: 100%;
		background: #e0e0e0;
		height: 10px;
		border-radius: 5px;
		overflow: hidden;
	}
	.progress-bar-fill {
		height: 100%;
		background: #FFD700; /* Primary color (gold) */
		transition: width 0.3s ease;
	}
	/* Progress Item Styles */
	.progress-item {
		display: flex;
		align-items: center;
		padding: 8px;
		border-radius: 5px;
		font-family: 'Poppins', sans-serif;
		font-size: 14px;
	}
	/* Ensure progress bar is always visible */
	.progress-bar-container {
		padding: 0 1rem; /* Match the padding of collapsible-header */
	}

	/* Adjust padding for progress details when expanded */
	#progress-details {
		padding: 0; /* Remove extra padding since progress-item has its own padding */
	}
	.progress-icon {
		font-size: 18px;
	}
	/* Adjust background for Form Progress section in dark mode */
	.dark #progress-tracker {
		background-color: #1f2937; /* Tailwind's gray-900 */
	}

	/* Adjust background for progress items in dark mode */
	.dark .progress-item {
		background-color: #374151; /* Tailwind's gray-800 */
	}
	/* Icon States */
	.progress-icon.not-started {
		color: #ccc; /* Gray for not started */
	}
	.progress-icon.in-progress {
		color: #f59e0b; /* Amber for in progress */
	}
	.progress-icon.completed {
		color: #10b981; /* Green for completed */
	}
	#generate-btn:not(.disabled-btn) {
		transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
	}

	#generate-btn:not(.disabled-btn):hover {
		background-color: #E6C200; /* Tailwind's secondary */
		transform: scale(1.05); /* Slight scale-up effect */
		box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Subtle shadow */
	}
    
	.signature-line {
		width: 120px;
		height: 2px;
		background: black;
		margin: 0 auto 6px;
	}
	
		/* Tag-based Selector Styles */
		.tag-selector {
			display: flex;
			flex-wrap: wrap;
			gap: 0.5rem;
			padding: 0.75rem;
			background-color: #f9fafb;
			border: 1px solid #e5e7eb;
			border-radius: 0.375rem;
			min-height: 3rem;
		}
		
		.dark .tag-selector {
			background-color: #1f2937;
			border-color: #374151;
		}
		
		.preset-tag {
			display: inline-flex;
			align-items: center;
			padding: 0.375rem 0.75rem;
			font-size: 0.875rem;
			font-weight: 500;
			border-radius: 0.375rem;
			background-color: #ffffff;
			border: 1px solid #d1d5db;
			color: #374151;
			cursor: pointer;
			transition: all 0.15s ease;
			user-select: none;
		}
		
		.preset-tag:hover {
			background-color: #f3f4f6;
			border-color: #9ca3af;
		}
		
		.preset-tag.selected {
			background-color: #10b981;
			color: #ffffff;
			border-color: #059669;
		}
		
		.preset-tag.selected:hover {
			background-color: #059669;
		}
		
		.dark .preset-tag {
			background-color: #374151;
			border-color: #4b5563;
			color: #d1d5db;
		}
		
		.dark .preset-tag:hover {
			background-color: #4b5563;
		}
		
		.dark .preset-tag.selected {
			background-color: #10b981;
			color: #ffffff;
		}

</style>
    

    <script>
		// Preset values for tag-based selection
		const PRESET_VALUES = {
			position: [
				"GK", "RB", "CB", "LB", "RWB", "LWB",
				"CDM", "CM", "CAM", "RM", "LM",
				"RW", "LW", "CF", "ST"
			],
			strengths: [
				"Technique", "Decision making", "Off-the-ball movement", "Passing Range", "Finishing", "Crossing",
				"1v1 ability", "Positioning", "Ball control", "Passing accuracy",
				"Game intelligence", "Composure", "Sprinting speed", "Change of speed", "Agility", "Balance", "Power",
				"Coordination", "Endurance"
			],
			feedback: [
				"Hardworking", "Good hustle", "Team player", "Positive attitude",
				"Good adaptability", "Quick learner", "Coachable","Technical consistency",
				"Great tactical understanding", "Resilience", "Leadership potential",
				"Effective communication", "Good physical fitness", "Great commitment",
				"Punctuality", "Professional approach", "Growth mindset",
				"Match mentality",  "Competitive spirit",
				"Role model behavior"
			],
			improvement: [
				"Consistency", "Decision making", "Technical skills", "Defensive skills", "Offensive skills",
				"Playing under pressure", "Passing variety", "First touch",
				"Weak foot", "Aerial ability", "Transition speed",
				"Off-ball movement", "Body shape", "Physical conditioning", "Nutrition and recovery",
				 "Agility", "Speed","Communication", "Focus and concentration",
				"Handling pressure", "Risk management", "Time management",
				"Work rate",  "Game understanding",
				 "Leadership"
			],
			shortgoal: [
				"Improve attendance to 80%", "Improve grade", 
				"Master playing position", "Master specific technique", "Improve physical metric",
				"Enhance tactical awareness", "Achieve fitness target",
				"HKRT representative selection", "Promotion to Higher Age Group", 
				"Train with First Team", "Train with Higher Age Group", "Start 2 consecutive matches",
				"Start 5 consecutive matches", "Score/assist 3 goals", "3 Cleansheets"
				
			],
			longgoal: [
				"HKRT regular selection",
				"Professional contract", "Overseas football opportunity",
				"Academic scholarship", "Elite academy placement", 
				"National team pathway", "Leadership role",
				"Multi-position versatility"
			]
		};
		// GK-specific
		const gkStrengths = [
		  "Shot-stopping", "1v1 situations", "Aerial dominance", "Handling and catching",
		  "Distribution – throwing", "Distribution – kicking", "Sweeper-keeper ability",
		  "Starting positions", "Command of penalty area", "Communication with back line"
		];

		const gkImprovement = [
		  "Footwork speed", "Set-piece positioning", "Cross management",
		  "Reactions from close range", "Dealing with rebounds", "Claim vs stay decisions",
		  "Distribution accuracy under pressure", "Build-up play with centre backs",
		  "Recovery runs after high starting position"
		];

		const gkShortGoals = [
		  "Improve distribution accuracy under pressure", "Reduce goals conceded from set pieces",
		  "Increase successful 1v1 stops", "Improve cross claiming consistency"
		];

		const gkLongGoals = [
		  "Become first-choice goalkeeper", "Lead defensive organisation",
		  "Develop as a sweeper-keeper", "Earn national team goalkeeper selection"
		];

		// Junior (U7–U12 / Junior Academy)
		const juniorStrengths = [
		  "Enthusiasm", "Basic coordination", "Listening skills", "Enjoyment of training",
		  "Dribbling confidence", "Willingness to try new skills"
		];

		const juniorImprovement = [
		  "Ball mastery", "Basic first touch", "Basic passing technique",
		  "Concentration in sessions", "Understanding simple positions"
		];

		const juniorShortGoals = [
		   "Learn 3 new ball mastery moves",
		  "Use weak foot more in training", "Understand basic team shape", "Understand combination play with teammates"
		];

		// Senior (U18–U22) – optional
		const seniorShortGoals = [
		  "Earn regular starting position", "Maintain performance over full season",
		  "Increase physical output in matches", "Lead unit pressing"
		];

		const seniorLongGoals = [
		  "U22 regular", "Secure professional contract", "HKRT regular selection","First team promotion",
		  "Prepare for senior football load", "Leadership role in squad", "University scholarship"
		];

		const categoryColors = {
			tactical: ['#FFD700', '#FFC700', '#FFB700'],      // Bright gold to darker gold
			technical: ['#FFE55C', '#FFD93D', '#FFC107'],      // Light yellow to amber
			physical: ['#FFA500', '#FF9500', '#FF8500'],       // Orange-gold to deeper orange
			social: ['#FFED4E', '#FFDB1C', '#FFC900']          // Pale yellow to deep gold
		};

		const metricToCategory = {
			'Attacking': 'tactical',
			'Defending': 'tactical',
			'Transition Focus': 'tactical',
			'Fundamental': 'technical',
			'Execution': 'technical',
			'Decision Making': 'technical',
			'Speed': 'physical',
			'Agility': 'physical',
			'Coordination': 'physical',
			'Endurance': 'physical',
			'Communication': 'social',
			'Confidence': 'social',
			'Leadership': 'social',
			'Teamwork': 'social'
		};

		// Helper: Map metric display name to input ID
		function getInputIdForMetric(metricName) {
			const mapping = {
				'Attacking': 'tactical-attacking',
				'Defending': 'tactical-defending',
				'Transition Focus': 'tactical-transition',
				'Fundamental': 'technical-fundamental',
				'Execution': 'technical-execution',
				'Decision Making': 'technical-decision',
				'Speed': 'physical-speed',
				'Agility': 'physical-agility',
				'Coordination': 'physical-coordination',
				'Endurance': 'physical-endurance',
				'Communication': 'social-communication',
				'Confidence': 'social-confidence',
				'Leadership': 'social-leadership',
				'Teamwork': 'social-teamwork'
			};
			return mapping[metricName] || '';
		}

		// Prepare radar chart data with all 14 metrics and Lee Man colors
		function prepareRadarData() {
			const radarLabels = [];
			const radarData = [];
			const radarBackgroundColors = [];
			
			const metricsOrder = [
				'Attacking', 'Defending', 'Transition Focus',           // Tactical (3)
				'Fundamental', 'Execution', 'Decision Making',          // Technical (3)
				'Speed', 'Agility', 'Coordination', 'Endurance',        // Physical (4)
				'Communication', 'Confidence', 'Leadership', 'Teamwork' // Social (4)
			];
			
			metricsOrder.forEach((metric, index) => {
				const inputId = getInputIdForMetric(metric);
				const inputElement = document.getElementById(inputId);
				const score = inputElement ? parseInt(inputElement.value) || 0 : 0;
				
				const category = metricToCategory[metric];
				const colorIndex = Math.floor(index / 3.5) % 3;
				const color = categoryColors[category][colorIndex];
				
				radarLabels.push(metric);
				radarData.push(score);
				radarBackgroundColors.push(color);
			});
			
			return {
				labels: radarLabels,
				datasets: [{
					label: 'Player Evaluation',
					data: radarData,
					backgroundColor: radarBackgroundColors,
					borderColor: radarBackgroundColors,
					borderWidth: 1,
					fill: true,
					tension: 0.3,
					pointBackgroundColor: radarBackgroundColors,
					pointBorderColor: '#fff',
					pointBorderWidth: 2,
					pointRadius: 5,
					pointHoverRadius: 7
				}]
			};
		}
		
		// Update radar chart with all 14 metrics
		// Update custom sunburst/pie chart with all 14 metrics - responsive & print-safe
		function updateRadarChart() {
			const canvasElement = document.getElementById('skills-radar');
			if (!canvasElement) return;
			
			const ctx = canvasElement.getContext('2d');
			
			// Force higher internal resolution for a sharper radar (especially for print)
			const container    = canvasElement.parentElement;
			const baseCssWidth = container.clientWidth || 280;
			const baseCssHeight = 200;

			// Choose how sharp you want it: 2 = 2x resolution, 3 = 3x, etc.
			const scaleFactor = 3;

			const cssWidth  = baseCssWidth;
			const cssHeight = baseCssHeight;
			const dpr       = scaleFactor;

			canvasElement.width  = cssWidth * dpr;
			canvasElement.height = cssHeight * dpr;

			// Reset transform then scale
			ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

			canvasElement.style.width  = cssWidth + 'px';
			canvasElement.style.height = cssHeight + 'px';

			
			// Clear canvas
			ctx.fillStyle = '#ffffff';
			ctx.fillRect(0, 0, cssWidth, cssHeight);
			
			// Chart configuration
			const centerX = cssWidth / 2;
			const centerY = cssHeight / 2;
			const maxRadius = 95;
			const radiusScale = maxRadius / 5;
			const sliceAngle = (Math.PI * 2) / 14;
			
			
			// Metrics with shortened labels
			const metricsOrder = [
				{ name: 'Attacking', short: 'Att.', category: 'tactical' },
				{ name: 'Defending', short: 'Def.', category: 'tactical' },
				{ name: 'Transition Focus', short: 'Trans.', category: 'tactical' },
				
				{ name: 'Speed', short: 'Spd.', category: 'physical' },
				{ name: 'Agility', short: 'Agi.', category: 'physical' },
				{ name: 'Coordination', short: 'Coord.', category: 'physical' },
				{ name: 'Endurance', short: 'End.', category: 'physical' },
				{ name: 'Communication', short: 'Comm.', category: 'social' },
				{ name: 'Confidence', short: 'Conf.', category: 'social' },
				{ name: 'Leadership', short: 'Lead.', category: 'social' },
				{ name: 'Teamwork', short: 'Team.', category: 'social' },
				{ name: 'Fundamental', short: 'Fund.', category: 'technical' },
				{ name: 'Execution', short: 'Exec.', category: 'technical' },
				{ name: 'Decision Making', short: 'Dec.', category: 'technical' }
			];
			
			const categoryColors = {
				tactical: '#FFD700',    // Gold
				technical: '#B4E600',   // Lime
				physical: '#FF9800',    // Orange
				social: '#7EC8FF'       // Blue
			};
			
			// Get metric values
			const values = metricsOrder.map((metric) => {
				const inputId = getInputIdForMetric(metric.name);
				const inputElement = document.getElementById(inputId);
				const score = inputElement ? parseInt(inputElement.value) || 3 : 3;
				return { ...metric, value: score };
			});
			
			// Draw slices
			values.forEach((metric, index) => {
				const startAngle = index * sliceAngle - Math.PI / 2;
				const endAngle = startAngle + sliceAngle;
				const radius = metric.value * radiusScale;
				const color = categoryColors[metric.category];
				
				// Draw slice (filled pie wedge from center)
				ctx.beginPath();
				ctx.moveTo(centerX, centerY);
				ctx.arc(centerX, centerY, radius, startAngle, endAngle);
				ctx.lineTo(centerX, centerY);
				ctx.closePath();
				
				ctx.fillStyle = color;
				ctx.fill();
				
				// Draw border around slice
				ctx.strokeStyle = '#333333';
				ctx.lineWidth = 0.8;
				ctx.stroke();
			});
			
			// Draw 4 CATEGORY borders (wrapping around full circle)
			// Borders at: end of Tactical (index 3), Technical (index 6), Physical (index 10), Social (index 14→0)
			const categoryEndIndices = [2, 6, 10, 13]; // Last index of each category (0-indexed)
			
			// Use fixed max radius for all borders (ensures uniform length)
			const fixedBorderRadius = maxRadius + 5;  // Always extends slightly beyond max

			categoryEndIndices.forEach((endIndex) => {
				// Border after this category (between categories)
				const borderIndex = (endIndex + 1) % 14;
				const angle = (borderIndex * sliceAngle) - Math.PI / 2;
				
				const x1 = centerX + Math.cos(angle) * 2;
				const y1 = centerY + Math.sin(angle) * 2;
				const x2 = centerX + Math.cos(angle) * fixedBorderRadius;
				const y2 = centerY + Math.sin(angle) * fixedBorderRadius;
				
				ctx.strokeStyle = '#333333';
				ctx.lineWidth = 2;
				ctx.beginPath();
				ctx.moveTo(x1, y1);
				ctx.lineTo(x2, y2);
				ctx.stroke();
			});

			
			
			
			
			
			// Draw metric labels VERY CLOSE to pie
			ctx.font = 'bold 10px Arial';
			ctx.fillStyle = '#333333';
			ctx.textAlign = 'center';
			ctx.textBaseline = 'middle';
			
			values.forEach((metric, index) => {
				const angle = (index * sliceAngle) + (sliceAngle / 2) - Math.PI / 2;
				const labelRadius = 90; // MUCH closer to pie edge
				const x = centerX + Math.cos(angle) * labelRadius;
				const y = centerY + Math.sin(angle) * labelRadius;
				
				ctx.save();
				ctx.translate(x, y);
				ctx.fillText(metric.short, 0, 0);
				ctx.restore();
			});
			
			// Draw value numbers in slice centers
			ctx.font = 'bold 10px Arial';
			ctx.fillStyle = '#333333';
			
			values.forEach((metric, index) => {
				const angle = (index * sliceAngle) + (sliceAngle / 2) - Math.PI / 2;
				const radius = 66;
				const x = centerX + Math.cos(angle) * radius;
				const y = centerY + Math.sin(angle) * radius;
				
				ctx.textAlign = 'center';
				ctx.textBaseline = 'middle';
				ctx.fillText(metric.value, x, y);
			});
		}




		function getTagPools(position, ageGroup) {
		  const pos = (position || '').toUpperCase();
		  const ag = (ageGroup || '').toUpperCase();

		  const isGK = pos.includes('GK') || pos.includes('GOALKEEPER');
		  const isJunior = ['U7','U8','U9','U10','U11','U12','JUNIOR ACADEMY'].includes(ag);
		  const isSenior = ['U18','U20','U22'].includes(ag);

		  let s = strengths;
		  let f = feedback;
		  let imp = improvement;
		  let sg = shortgoal;
		  let lg = longgoal;

		  if (isGK) {
			if (gkStrengths) s = gkStrengths;
			if (gkImprovement) imp = gkImprovement;
			if (gkShortGoals) sg = gkShortGoals;
			if (gkLongGoals) lg = gkLongGoals;
		  } else if (isJunior) {
			if (juniorStrengths) s = juniorStrengths;
			if (juniorImprovement) imp = juniorImprovement;
			if (juniorShortGoals) sg = juniorShortGoals;
		  } else if (isSenior) {
			if (seniorShortGoals) sg = seniorShortGoals;
			if (seniorLongGoals) lg = seniorLongGoals;
		  }

		  return { strengths: s, feedback: f, improvement: imp, shortgoal: sg, longgoal: lg };
		}

		function getExtraTagsForContext(position, ageGroup) {
		  const pos = (position || '').toUpperCase();
		  const ag = (ageGroup || '').toUpperCase();

		  const isGK = pos.includes('GK') || pos.includes('GOALKEEPER');
		  const isJunior = ['U7','U8','U9','U10','U11','U12','JUNIOR ACADEMY'].includes(ag);
		  const isSenior = ['U18','U20','U22'].includes(ag);

		  const extra = {
			strengths: [],
			feedback: [],
			improvement: [],
			shortgoal: [],
			longgoal: []
		  };

		  if (isGK) {
			if (gkStrengths) extra.strengths.push(...gkStrengths);
			if (gkImprovement) extra.improvement.push(...gkImprovement);
			if (gkShortGoals) extra.shortgoal.push(...gkShortGoals);
			if (gkLongGoals) extra.longgoal.push(...gkLongGoals);
		  }

		  if (isJunior) {
			if (juniorStrengths) extra.strengths.push(...juniorStrengths);
			if (juniorImprovement) extra.improvement.push(...juniorImprovement);
			if (juniorShortGoals) extra.shortgoal.push(...juniorShortGoals);
		  }

		  if (isSenior) {
			if (seniorShortGoals) extra.shortgoal.push(...seniorShortGoals);
			if (seniorLongGoals) extra.longgoal.push(...seniorLongGoals);
		  }

		  return extra;
		}

		// Initialize tag selectors
		function initializeTagSelectors() {
			Object.keys(PRESET_VALUES).forEach(type => {
				const container = document.getElementById(`${type}-tags`);
				if (container) {
					PRESET_VALUES[type].forEach(value => {
						const tag = document.createElement('span');
						tag.className = 'preset-tag';
						tag.textContent = value;
						tag.dataset.value = value;
						tag.onclick = () => toggleTag(tag, type);
						container.appendChild(tag);
					});
				}
			});
			
			// Initialize character counters
			['position', 'strengths', 'feedback', 'improvement', 'shortgoal', 'longgoal'].forEach(type => {
				const inputField = document.getElementById(type === 'feedback' ? 'coach-feedback-manual' : type === 'position' ? 'manual-position' : `${type}-manual`);
				const counter = document.getElementById(`${type}-counter`);
				if (inputField && counter) {
					inputField.addEventListener('input', () => updateCharCounter(type));
				}
			});

		}
		
		function refreshTagsForType(type, extraValues = []) {
		  const container = document.getElementById(`${type}-tags`);
		  if (!container) return;

		  // Clear existing tags
		  container.innerHTML = '';

		  // Base values from PRESET_VALUES
		  const baseValues = PRESET_VALUES[type] || [];

		  // Merge base + extra (avoid duplicates)
		  const allValues = [...baseValues, ...extraValues].filter((v, i, arr) => arr.indexOf(v) === i);

		  allValues.forEach(value => {
			const tag = document.createElement('span');
			tag.className = 'preset-tag';
			tag.textContent = value;
			tag.dataset.value = value;
			tag.onclick = () => toggleTag(tag, type);
			container.appendChild(tag);
		  });
		}

		
		
		// Toggle tag selection
		function toggleTag(tag, type) {
			tag.classList.toggle('selected');
			updateCharCounter(type);
			updateProgress();

			if (type === 'position') {
				updateContextTags();
			}
		}
		
		

		
		// Update character counter
		function updateCharCounter(type) {
			const manual = document.getElementById(`${type === 'feedback' ? 'coach-feedback' : type}-manual`);
			const counter = document.getElementById(`${type}-counter`);
			const combined = getCombinedText(type);
			if (counter) {
				counter.textContent = `${combined.length}/200`;
				counter.style.color = combined.length > 200 ? '#ef4444' : '#6b7280';
			}
		}
		


		// Get combined text from tags and manual input
		function getCombinedText(type) {
			const container = document.getElementById(`${type}-tags`);
			const manual = document.getElementById(`${type === 'feedback' ? 'coach-feedback' : type}-manual`);
			
			const selectedTags = [];
			if (container) {
				container.querySelectorAll('.preset-tag.selected').forEach(tag => {
					selectedTags.push(tag.dataset.value);
				});
			}
			
			const manualText = manual ? manual.value.trim() : '';
			const combined = [...selectedTags, manualText].filter(Boolean).join(', ');
			return combined;
		}

		// === Context-sensitive tags (age group + position) ===
		const positionInput = document.getElementById('manual-position');
		const ageGroupSelect = document.getElementById('manual-age-group');

		function updateContextTags() {
			const position = getCombinedText('position') || (positionInput?.value || '');
			const ageGroup = ageGroupSelect?.value || '';

			const extra = getExtraTagsForContext(position, ageGroup);

			refreshTagsForType('strengths', extra.strengths);
			refreshTagsForType('feedback', extra.feedback);
			refreshTagsForType('improvement', extra.improvement);
			refreshTagsForType('shortgoal', extra.shortgoal);
			refreshTagsForType('longgoal', extra.longgoal);
		}









        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#FFD700',
                        secondary: '#E6C200',
						accent: '#2D3748',
                        textPrimary: '#1A1A1A'
                    },
                    fontFamily: {
					  sans: ['Poppins', 'Helvetica', 'Arial', 'sans-serif'],
					}
									}
            },
            darkMode: 'class'
        }
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            document.documentElement.classList.toggle('dark', event.matches);
        });
    </script>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-200 min-h-screen">
    <!-- Main App Container -->
    <div id="app-container" class="container mx-auto px-4 py-6 max-w-5xl">
		<header class="text-center mb-8">
			<div class="flex justify-between items-center">
				<h1 class="text-3xl font-bold text-primary bg-gradient-to-r from-primary to-secondary text-transparent bg-clip-text">
					Lee Man Youth Academy Player Review Generator
				</h1>
				<a href="https://melvinlhchow.github.io/LMPlayerReport/readme.html" target="_blank" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-secondary transition-colors">View README</a>
			</div>
			<p class="text-gray-600 dark:text-gray-300 dark:text-gray-400">Create comprehensive player review reports for your academy players</p>
		</header>
		<div id="progress-tracker" class="mb-6 bg-gray-100 dark:bg-gray-800 p-4 rounded-lg shadow-custom">
			<!-- Collapsible Header -->
			<div class="collapsible-header" data-section="progress">
				<h2 class="text-lg font-semibold text-primary">Form Progress</h2>
				<span class="toggle-icon"></span>
			</div>
			<!-- Progress Bar (Always Visible) -->
			<div class="progress-bar-container mb-4">
				<div class="progress-bar">
					<div id="progress-bar-fill" class="progress-bar-fill" style="width: 0%;"></div>
				</div>
				<div class="text-sm text-gray-600 dark:text-gray-300 mt-1">
					<span id="progress-percentage">0%</span> Complete
				</div>
			</div>
			<!-- Collapsible Content (Hidden by Default) -->
			<div class="collapsible-content" id="progress-details">
				<div class="space-y-2">
					<div class="progress-item flex items-center p-2 rounded-md bg-white dark:bg-gray-700">
						<span class="progress-icon mr-2" id="icon-player">⏳</span>
						<span>Player Data</span>
						<span class="ml-auto text-sm text-gray-600 dark:text-gray-300" id="progress-player">Not Started</span>
					</div>
					<div class="progress-item flex items-center p-2 rounded-md bg-white dark:bg-gray-700">
						<span class="progress-icon mr-2" id="icon-height">⏳</span>
						<span>Physical Data</span>
						<span class="ml-auto text-sm text-gray-600 dark:text-gray-300" id="progress-height">Not Started</span>
					</div>
					<div class="progress-item flex items-center p-2 rounded-md bg-white dark:bg-gray-700">
						<span class="progress-icon mr-2" id="icon-attendance">⏳</span>
						<span>Attendance</span>
						<span class="ml-auto text-sm text-gray-600 dark:text-gray-300" id="progress-attendance">Not Started</span>
					</div>
					<div class="progress-item flex items-center p-2 rounded-md bg-white dark:bg-gray-700">
						<span class="progress-icon mr-2" id="icon-ratings">⏳</span>
						<span>Performance Ratings</span>
						<span class="ml-auto text-sm text-gray-600 dark:text-gray-300" id="progress-ratings">Not Started</span>
					</div>
					<div class="progress-item flex items-center p-2 rounded-md bg-white dark:bg-gray-700">
						<span class="progress-icon mr-2" id="icon-grades">⏳</span>
						<span>Grades</span>
						<span class="ml-auto text-sm text-gray-600 dark:text-gray-300" id="progress-grades">Not Started</span>
					</div>
					<div class="progress-item flex items-center p-2 rounded-md bg-white dark:bg-gray-700">
						<span class="progress-icon mr-2" id="icon-feedback">⏳</span>
						<span>Feedback</span>
						<span class="ml-auto text-sm text-gray-600 dark:text-gray-300" id="progress-feedback">Not Started</span>
					</div>
					<div class="progress-item flex items-center p-2 rounded-md bg-white dark:bg-gray-700">
						<span class="progress-icon mr-2" id="icon-signatures">⏳</span>
						<span>Signatures</span>
						<span class="ml-auto text-sm text-gray-600 dark:text-gray-300" id="progress-signatures">Not Started</span>
					</div>
				</div>
			</div>
		</div>
		
		<div id="status-message" class="mt-6 py-2 px-4 rounded-md hidden"></div>
        <div class="grid grid-cols-1 lg:grid-cols-1 gap-8">
				<div class="bg-gray-50 dark:bg-gray-800 p-8 rounded-lg shadow-custom">
                    <h2 class="text-xl font-semibold mb-4 text-primary">Instructions</h2>
                    <div class="space-y-3 text-sm">
                        <p>1. Enter player information manually or upload from a file</p>
                        <p>2. Upload the player's portrait photo</p>
                        <p>3. Upload the club logo (optional)</p>
                        <p>4. Rate the player on all 14 performance metrics</p>
                        <p>5. Add detailed feedback and improvement areas</p>
                        <p>6. Click 'Generate Report' to preview</p>
                        <p>7. Use the 'Print Report' button to open a printable version</p>
                        <p>8. In the print dialog, select "Save as PDF" to download</p>
                        <p class="text-primary font-medium">Note: Player data is only used for the current session and isn't saved between sessions.</p>
                    </div>
                </div>   
			<!-- Input Section -->
            <div class="bg-gray-50 dark:bg-gray-800 p-8 rounded-lg shadow-custom border border-gradient-to-r from-primary to-secondary">
				<div class="collapsible-section">
				<div class="collapsible-header" data-section="player">
					<h2 class="text-xl font-semibold text-primary">Player Data Input</h2>
					<span class="toggle-icon"></span>
				</div>
				<div class="collapsible-content">
                
                <!-- Player Data Input Method Toggle -->
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-1">Data Input Method</label>
                    <div class="flex space-x-4">
                        <label class="inline-flex items-center">
                            <input type="radio" name="player-input-method" value="manual" checked class="text-primary focus:ring-primary" id="manual-player-data">
                            <span class="ml-2">Manual Input</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="player-input-method" value="file" class="text-primary focus:ring-primary" id="file-player-data">
                            <span class="ml-2">Upload File</span>
                        </label>
                    </div>
                </div>
                
				
				<div id="player-file-input" class="mb-6 space-y-4 hidden">
                <!-- File Upload Section -->
				
					<div>
						<label class="block text-sm font-medium mb-1" for="xlsFile">Upload Player Data (XLS/XLSX)</label>
						<input type="file" id="xlsFile" accept=".xls,.xlsx" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-primary file:text-white hover:file:bg-secondary cursor-pointer" />
						<div class="mt-2">
							<a href="https://melvinlhchow.github.io/LMPlayerReport/player_data_template.xlsx" 
							   download="player_data_template.xlsx" 
							   class="inline-flex items-center px-4 py-2 bg-primary text-white rounded-md hover:bg-secondary transition-colors">
								<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
								</svg>
								Download Excel Template
							</a>
						</div>
						<p class="mt-1 text-xs text-gray-500 dark:text-gray-300">Please use the provided template for data input to ensure compatibility.</p>
					</div>
					<div id="playerSelectContainer" class="hidden">
						<label class="block text-sm font-medium mb-1" for="playerSelect">Select Player</label>
						<select id="playerSelect" class="w-full rounded-md border-gray-300 shadow-sm p-2 bg-white dark:bg-gray-700">
							<option value="">Select a player...</option>
						</select>
					</div>
				</div>
								
                <!-- Manual Player Data Input -->
                <div id="player-manual-input" class="mb-6 space-y-4">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>                           
							<label for="manual-first-name" class="block text-sm font-medium mb-1">First Name<span class="text-red-400 text-xs">*</span></label>
							<input type="text" id="manual-first-name" class="w-full rounded-md border-gray-300 shadow-sm p-2 bg-white dark:bg-gray-700 text-base placeholder-gray-400 required-field" placeholder="Enter first name">
						</div>
                        <div>
                            <label for="manual-last-name" class="block text-sm font-medium mb-1">Last Name<span class="text-red-400 text-xs">*</span></label>
							<input type="text" id="manual-last-name" class="w-full rounded-md border-gray-300 shadow-sm p-2 bg-white dark:bg-gray-700 text-base placeholder-gray-400 required-field" placeholder="Enter last name">
						</div>
                    </div>
                    <div>
                        <label for="manual-dob" class="block text-sm font-medium mb-1">Date of Birth</label>
                        <input type="date" id="manual-dob" class="w-full rounded-md border-gray-300 shadow-sm p-2 bg-white dark:bg-gray-700 text-base placeholder-gray-400">
                    </div>
					<div>
						<label class="block text-sm font-medium mb-2">Position</label>
						<div class="tag-selector mb-2" id="position-tags"></div>
						<input type="text" id="manual-position" class="w-full rounded-md border-gray-300 shadow-sm p-2 bg-white dark:bg-gray-700 text-base" placeholder="Add custom position..." maxlength="50">
						<div class="text-xs text-gray-500 mt-1">
							<span id="position-counter">0/50</span> characters
						</div>
					</div>
                    <div>
                        <label for="manual-age-group" class="block text-sm font-medium mb-1">Age Group <span class="text-red-500">*</span></label>
                        <select id="manual-age-group" class="w-full rounded-md border-gray-300 shadow-sm p-2 bg-white dark:bg-gray-700 text-base" required>
                            <option value="">Select Age Group</option>
                            <option value="U22">U22</option>
                            <option value="U18">U18</option>
                            <option value="U16">U16</option>
                            <option value="U14">U14</option>
                            <option value="U12">U12</option>
                            <option value="U10">U10</option>
                            <option value="U9">U9</option>
                            <option value="U8">U8</option>
                            <option value="U7">U7</option>
                            <option value="Junior Academy">Junior Academy</option>
                        </select>
                    </div>
                </div>
                
				<div>
					<label class="block text-sm font-medium mb-1" for="portraitFile">Upload Player Portrait <span class="text-red-400 text-xs">*</span></label>
					<input type="file" id="portraitFile" accept="image/jpeg,image/png" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-primary file:text-white hover:file:bg-secondary cursor-pointer hover:border-primary focus:ring-2 focus:ring-primary required-field" />
					<div id="cropperContainer" style="display: none; margin-top: 10px;">
						<img id="imageToCrop" class="max-w-full">
						<div class="mt-2">
							<button type="button" id="cropButton" class="py-2 px-4 rounded-md border-0 text-sm font-semibold bg-primary text-white hover:bg-secondary cursor-pointer">Crop Image</button>
							<button type="button" id="cancelCropButton" class="py-2 px-4 rounded-md border-0 text-sm font-semibold bg-red-500 text-white hover:bg-red-600 cursor-pointer">Cancel</button>
						</div>
					</div>
					<div id="croppedImagePreview" class="mt-2">
						<img id="croppedImage" style="display: none; width: 100px; height: 100px; border-radius: 50%; object-fit: cover;" class="rounded-full">
					</div>
				</div>
                
                <!-- Club Logo Upload (Optional) -->
                <div class="mt-4">
                    <label class="block text-sm font-medium mb-1" for="clubLogoFile">Upload Club Logo (Optional)</label>
                    <input type="file" id="clubLogoFile" accept="image/jpeg,image/png,image/svg+xml" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-primary file:text-white hover:file:bg-secondary cursor-pointer" />
                    <p class="mt-1 text-xs text-gray-500 dark:text-gray-300">If not provided, a default club logo will be used.</p>
                </div>
				</div></div>

				<!-- Physical Data Section -->
				<div class="collapsible-section mt-6">
					<div class="collapsible-header" data-section="physical">
						<h3 class="font-medium text-lg">Physical Data</h3>
						<span class="toggle-icon"></span>
					</div>
					<div class="collapsible-content" id="physical-data-section">
						<div class="bg-white dark:bg-gray-800 p-4 rounded-md mb-4 border">
							<!-- Basic Physical Metrics -->
							<div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
								<div>
									<label for="player-height" class="block text-sm font-medium mb-1">Height (cm)</label>
									<input type="number" id="player-height" step="0.1" class="w-full rounded-md border-gray-300 shadow-sm p-2 bg-white dark:bg-gray-700 text-base" placeholder="e.g., 175.5">
								</div>
								<div>
									<label for="player-weight" class="block text-sm font-medium mb-1">Weight (kg)</label>
									<input type="number" id="player-weight" step="0.1" class="w-full rounded-md border-gray-300 shadow-sm p-2 bg-white dark:bg-gray-700 text-base" placeholder="e.g., 68.5">
								</div>
							</div>
							
							<!-- Physical Test Data -->
							<div class="mt-4">
								<h4 class="font-medium text-base mb-3 text-gray-700 dark:text-gray-300">Physical Test Data</h4>
								<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
									<div>
										<label for="test-10m-sprint" class="block text-sm font-medium mb-1">10M Sprint (seconds)</label>
										<input type="number" id="test-10m-sprint" step="0.01" class="w-full rounded-md border-gray-300 shadow-sm p-2 bg-white dark:bg-gray-700 text-base" placeholder="e.g., 1.85">
									</div>
									<div>
										<label for="test-30m-sprint" class="block text-sm font-medium mb-1">30M Sprint (seconds)</label>
										<input type="number" id="test-30m-sprint" step="0.01" class="w-full rounded-md border-gray-300 shadow-sm p-2 bg-white dark:bg-gray-700 text-base" placeholder="e.g., 4.20">
									</div>
									<div>
										<label for="test-cmj" class="block text-sm font-medium mb-1">CMJ (cm)</label>
										<input type="number" id="test-cmj" step="0.1" class="w-full rounded-md border-gray-300 shadow-sm p-2 bg-white dark:bg-gray-700 text-base" placeholder="e.g., 45.0">
									</div>
									<div>
										<label for="test-yoyo" class="block text-sm font-medium mb-1">Yo-Yo IR1 (level)</label>
										<input type="text" id="test-yoyo" class="w-full rounded-md border-gray-300 shadow-sm p-2 bg-white dark:bg-gray-700 text-base" placeholder="e.g., 18.4">
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>

				<!-- Attendance Data Section -->
				<div class="collapsible-section mt-6">
					<div class="collapsible-header" data-section="attendance">
                        <h3 class="font-medium text-lg">Attendance Data</h3>
                             <span class="toggle-icon"></span>
                    </div>
					<div class="collapsible-content" id="attendance-section">
                    
					<div class="bg-white dark:bg-gray-800 p-4 rounded-md mb-4 border">
						<div class="mb-4">
							<label class="block text-sm font-medium mb-1">Data Input Method</label>
							<div class="flex space-x-4">
								<label class="inline-flex items-center">
									<input type="radio" name="attendance-input-method" value="manual" checked class="text-primary focus:ring-primary" id="manual-attendance">
									<span class="ml-2">Manual Input</span>
								</label>
								<label class="inline-flex items-center">
									<input type="radio" name="attendance-input-method" value="file" class="text-primary focus:ring-primary" id="file-attendance">
									<span class="ml-2">Upload File</span>
								</label>
							</div>
						</div>
						<div id="attendance-file-input" class="hidden mb-4">
							<label class="block text-sm font-medium mb-1" for="attendanceFile">Upload Attendance Data (XLS/XLSX)</label>
							<input type="file" id="attendanceFile" accept=".xls,.xlsx" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-primary file:text-white hover:file:bg-secondary cursor-pointer" />
							<p class="mt-1 text-xs text-gray-500 dark:text-gray-300">File should include training and match attendance data.</p>
						</div>
						<div id="attendance-manual-input">
							<div class="mb-4">
								<h4 class="font-medium text-md mb-2">Training Attendance</h4>
								<div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
									<div>
										<label class="block text-sm mb-1" for="total-training-sessions">Total Sessions</label>
										<input type="number" min="0" id="total-training-sessions" class="w-full rounded-md border-gray-300 shadow-sm p-2 bg-white dark:bg-gray-600 text-base hover:border-primary focus:ring-2 focus:ring-primary" value="0">
									</div>
									<div>
										<label class="block text-sm mb-1" for="training-sessions-attended">Sessions Attended</label>
										<input type="number" min="0" id="training-sessions-attended" class="w-full rounded-md border-gray-300 shadow-sm p-2 bg-white dark:bg-gray-600 text-base hover:border-primary focus:ring-2 focus:ring-primary" value="0">
									</div>
									<div>
										<label class="block text-sm mb-1" for="total-training-minutes">Total Minutes</label>
										<input type="number" min="0" id="total-training-minutes" class="w-full rounded-md border-gray-300 shadow-sm p-2 bg-white dark:bg-gray-600 text-base hover:border-primary focus:ring-2 focus:ring-primary" value="0">
									</div>
								</div>
							</div>
							<div>
								<h4 class="font-medium text-md mb-2">Match Clock</h4>
								<div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
									<div>
										<label class="block text-sm mb-1" for="total-matches">Total Matches</label>
										<input type="number" min="0" id="total-matches" class="w-full rounded-md border-gray-300 shadow-sm p-2 bg-white dark:bg-gray-600 text-base hover:border-primary focus:ring-2 focus:ring-primary" value="0">
									</div>
									<div>
										<label class="block text-sm mb-1" for="matches-played">Matches Played</label>
										<input type="number" min="0" id="matches-played" class="w-full rounded-md border-gray-300 shadow-sm p-2 bg-white dark:bg-gray-600 text-base hover:border-primary focus:ring-2 focus:ring-primary" value="0">
									</div>
									<div>
										<label class="block text-sm mb-1" for="total-match-minutes">Total Match Minutes</label>
										<input type="number" min="0" id="total-match-minutes" class="w-full rounded-md border-gray-300 shadow-sm p-2 bg-white dark:bg-gray-600 text-base hover:border-primary focus:ring-2 focus:ring-primary" value="0">
									</div>
									<div>
										<label class="block text-sm mb-1" for="match-minutes-played">Match Minutes Played</label>
										<input type="number" min="0" id="match-minutes-played" class="w-full rounded-md border-gray-300 shadow-sm p-2 bg-white dark:bg-gray-600 text-base hover:border-primary focus:ring-2 focus:ring-primary" value="0">
									</div>
								</div>
							</div>
						</div>
					</div>
					
					</div>
                </div>
                
                <!-- Rating Sliders -->
				<div class="collapsible-section mt-6">
					<div class="collapsible-header" data-section="ratings">
						<h3 class="font-medium text-lg">Performance Metrics</h3>
						<span class="toggle-icon"></span>
					</div>
					<div class="collapsible-content" id="ratings-section">
						<div class="bg-white dark:bg-gray-800 p-4 rounded-md border">
							<p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Rate the player on each metric (1 = Poor, 5 = Excellent)</p>
							
							<!-- Tactical Category -->
							<div class="mb-6">
								<h4 class="font-semibold text-base mb-3 text-green-700 dark:text-green-400">Tactical (<span id="tactical-avg"></span>)</h4>
								<div class="space-y-3">
									<div class="rating-item">
										<label class="rating-label">Attacking</label>
										<input type="range" id="tactical-attacking" min="1" max="5" value="3" class="rating-slider">
										<span class="rating-value">3</span>
									</div>
									<div class="rating-item">
										<label class="rating-label">Defending</label>
										<input type="range" id="tactical-defending" min="1" max="5" value="3" class="rating-slider">
										<span class="rating-value">3</span>
									</div>
									<div class="rating-item">
										<label class="rating-label">Transition Focus</label>
										<input type="range" id="tactical-transition" min="1" max="5" value="3" class="rating-slider">
										<span class="rating-value">3</span>
									</div>
								</div>
							</div>
							
							<!-- Technical Category -->
							<div class="mb-6">
								<h4 class="font-semibold text-base mb-3 text-blue-700 dark:text-blue-400">Technical (<span id="technical-avg"></span>)</h4>
								<div class="space-y-3">
									<div class="rating-item">
										<label class="rating-label">Fundamental</label>
										<input type="range" id="technical-fundamental" min="1" max="5" value="3" class="rating-slider">
										<span class="rating-value">3</span>
									</div>
									<div class="rating-item">
										<label class="rating-label">Execution</label>
										<input type="range" id="technical-execution" min="1" max="5" value="3" class="rating-slider">
										<span class="rating-value">3</span>
									</div>
									<div class="rating-item">
										<label class="rating-label">Decision Making</label>
										<input type="range" id="technical-decision" min="1" max="5" value="3" class="rating-slider">
										<span class="rating-value">3</span>
									</div>
								</div>
							</div>
							
							<!-- Physical Category -->
							<div class="mb-6">
								<h4 class="font-semibold text-base mb-3 text-orange-700 dark:text-orange-400">Physical (<span id="physical-avg"></span>)</h4>
								<div class="space-y-3">
									<div class="rating-item">
										<label class="rating-label">Speed</label>
										<input type="range" id="physical-speed" min="1" max="5" value="3" class="rating-slider">
										<span class="rating-value">3</span>
									</div>
									<div class="rating-item">
										<label class="rating-label">Agility</label>
										<input type="range" id="physical-agility" min="1" max="5" value="3" class="rating-slider">
										<span class="rating-value">3</span>
									</div>
									<div class="rating-item">
										<label class="rating-label">Coordination</label>
										<input type="range" id="physical-coordination" min="1" max="5" value="3" class="rating-slider">
										<span class="rating-value">3</span>
									</div>
									<div class="rating-item">
										<label class="rating-label">Endurance</label>
										<input type="range" id="physical-endurance" min="1" max="5" value="3" class="rating-slider">
										<span class="rating-value">3</span>
									</div>
								</div>
							</div>
							
							<!-- Social Category -->
							<div class="mb-6">
								<h4 class="font-semibold text-base mb-3 text-purple-700 dark:text-purple-400">Social (<span id="social-avg"></span>)</h4>
								<div class="space-y-3">
									<div class="rating-item">
										<label class="rating-label">Communication</label>
										<input type="range" id="social-communication" min="1" max="5" value="3" class="rating-slider">
										<span class="rating-value">3</span>
									</div>
									<div class="rating-item">
										<label class="rating-label">Confidence</label>
										<input type="range" id="social-confidence" min="1" max="5" value="3" class="rating-slider">
										<span class="rating-value">3</span>
									</div>
									<div class="rating-item">
										<label class="rating-label">Leadership</label>
										<input type="range" id="social-leadership" min="1" max="5" value="3" class="rating-slider">
										<span class="rating-value">3</span>
									</div>
									<div class="rating-item">
										<label class="rating-label">Teamwork</label>
										<input type="range" id="social-teamwork" min="1" max="5" value="3" class="rating-slider">
										<span class="rating-value">3</span>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>

				<!-- Grade Selection -->
				<div class="collapsible-section mt-6">
					<div class="collapsible-header" data-section="grades">
						<h3 class="font-medium text-lg">Player Grades</h3>
						<span class="toggle-icon"></span>
					</div>
					<div class="collapsible-content" id="grades-section">
						<div class="bg-white dark:bg-gray-800 p-4 rounded-md border">
							<div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
								<!-- Strengths Section -->
								<div class="mb-6">
									<label class="block text-sm font-medium mb-2">Strengths</label>
									<div class="tag-selector mb-2" id="strengths-tags"></div>
									<textarea id="strengths-manual" class="w-full rounded-md border-gray-300 shadow-sm p-2 bg-white dark:bg-gray-700 text-base" rows="2" maxlength="200" placeholder="Add custom strengths..."></textarea>
									<div class="text-xs text-gray-500 mt-1">
										<span id="strengths-counter">0/200</span> characters
									</div>
								</div>
								<div>
									<label for="current-grade" class="block text-sm font-medium mb-1">Current Grade</label>
									<select id="current-grade" class="w-full rounded-md border-gray-300 shadow-sm p-2 bg-white dark:bg-gray-700 text-base">
										<option value="">Select Grade</option>
										<option value="A+">A+</option>
										<option value="A">A</option>
										<option value="A-">A-</option>
										<option value="B+">B+</option>
										<option value="B">B</option>
										<option value="B-">B-</option>
										<option value="C+">C+</option>
										<option value="C">C</option>
										<option value="C-">C-</option>
										<option value="D">D</option>
										<option value="E">E</option>
									</select>
								</div>
							</div>
						</div>
					</div>
				</div>

				<!-- Feedback Section -->
				<div class="collapsible-section mt-6">
					<div class="collapsible-header" data-section="feedback">
						<h3 class="font-medium text-lg text-primary">Feedback & Goals</h3>
						<span class="toggle-icon"></span>
					</div>
					<div class="collapsible-content">
						<div class="bg-white dark:bg-gray-800 p-4 rounded-md border">

							
							<!-- Coach Feedback Section -->
							<div class="mb-6">
								<label class="block text-sm font-medium mb-2">Coach Feedback</label>
								<div class="tag-selector mb-2" id="feedback-tags"></div>
								<textarea id="coach-feedback-manual" class="w-full rounded-md border-gray-300 shadow-sm p-2 bg-white dark:bg-gray-700 text-base" rows="2" maxlength="200" placeholder="Add custom feedback..."></textarea>
								<div class="text-xs text-gray-500 mt-1">
									<span id="feedback-counter">0/200</span> characters
								</div>
							</div>
							
							<!-- Areas of Improvement Section -->
							<div class="mb-6">
								<label class="block text-sm font-medium mb-2">Areas of Improvement</label>
								<div class="tag-selector mb-2" id="improvement-tags"></div>
								<textarea id="improvement-manual" class="w-full rounded-md border-gray-300 shadow-sm p-2 bg-white dark:bg-gray-700 text-base" rows="2" maxlength="200" placeholder="Add custom areas..."></textarea>
								<div class="text-xs text-gray-500 mt-1">
									<span id="improvement-counter">0/200</span> characters
								</div>
							</div>
							
							<!-- Short-term Goal Section -->
							<div class="mb-6">
								<label class="block text-sm font-medium mb-2">Short-term Goal</label>
								<div class="tag-selector mb-2" id="shortgoal-tags"></div>
								<textarea id="shortgoal-manual" class="w-full rounded-md border-gray-300 shadow-sm p-2 bg-white dark:bg-gray-700 text-base" rows="2" maxlength="200" placeholder="Add custom short-term goal..."></textarea>
								<div class="text-xs text-gray-500 mt-1">
									<span id="shortgoal-counter">0/200</span> characters
								</div>
							</div>
							
							<!-- Long-term Goal Section -->
							<div class="mb-6">
								<label class="block text-sm font-medium mb-2">Long-term Goal</label>
								<div class="tag-selector mb-2" id="longgoal-tags"></div>
								<textarea id="longgoal-manual" class="w-full rounded-md border-gray-300 shadow-sm p-2 bg-white dark:bg-gray-700 text-base" rows="2" maxlength="200" placeholder="Add custom long-term goal..."></textarea>
								<div class="text-xs text-gray-500 mt-1">
									<span id="longgoal-counter">0/200</span> characters
								</div>
							</div>
						</div>
					</div>
				</div>

				<!-- Report Signatures Section -->
				<div class="collapsible-section mt-6">
					<div class="collapsible-header" data-section="signatures">
						<h3 class="font-medium text-lg text-primary">Report Sign-off</h3>
						<span class="toggle-icon"></span>
					</div>
					<div class="collapsible-content">
						<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
							<div>
								<label for="coach1-name" class="block text-sm font-medium mb-1">Coach 1 Name</label>
								<input type="text" id="coach1-name" class="w-full rounded-md border-gray-300 shadow-sm p-2 bg-white dark:bg-gray-700 text-base placeholder-gray-400 hover:border-primary focus:ring-2 focus:ring-primary" placeholder="Enter coach's name" value="Melvin Chow">
								<label for="coach1-title" class="block text-sm font-medium mb-1 mt-2">Title</label>
								<input type="text" id="coach1-title" class="w-full rounded-md border-gray-300 shadow-sm p-2 bg-white dark:bg-gray-700 text-base placeholder-gray-400 hover:border-primary focus:ring-2 focus:ring-primary" placeholder="Enter title" value="Coach">
							</div>
							<div>
								<label for="coach2-name" class="block text-sm font-medium mb-1">Coach 2 Name</label>
								<input type="text" id="coach2-name" class="w-full rounded-md border-gray-300 shadow-sm p-2 bg-white dark:bg-gray-700 text-base placeholder-gray-400 hover:border-primary focus:ring-2 focus:ring-primary" placeholder="Enter coach's name" value="Lee Hong Lim">
								<label for="coach2-title" class="block text-sm font-medium mb-1 mt-2">Title</label>
								<input type="text" id="coach2-title" class="w-full rounded-md border-gray-300 shadow-sm p-2 bg-white dark:bg-gray-700 text-base placeholder-gray-400 hover:border-primary focus:ring-2 focus:ring-primary" placeholder="Enter title" value="Coach">
							</div>
							<div>
								<label for="technical-director" class="block text-sm font-medium mb-1">Technical Director</label>
								<input type="text" id="technical-director" class="w-full rounded-md border-gray-300 shadow-sm p-2 bg-white dark:bg-gray-700 text-base placeholder-gray-400 hover:border-primary focus:ring-2 focus:ring-primary" placeholder="Enter technical director's name" value="Tsang Chiu Tat">
								<label for="technical-director-title" class="block text-sm font-medium mb-1 mt-2">Title</label>
								<input type="text" id="technical-director-title" class="w-full rounded-md border-gray-300 shadow-sm p-2 bg-white dark:bg-gray-700 text-base placeholder-gray-400 hover:border-primary focus:ring-2 focus:ring-primary" placeholder="Enter title" value="Technical Director">
							</div>
						</div>
					</div>
                </div>
                
                <div class="flex justify-between mt-8">
                    
					<button id="generate-btn" class="px-6 py-2 bg-primary text-white rounded-md hover:bg-secondary transition-colors flex items-center disabled-btn" disabled>
						<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
						Generate Report
					</button>
					<button id="reset-btn" class="px-6 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors flex items-center">
						<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5m11 11v-5h-5m-6 0l6-6m-6 6l6-6"></path></svg>
						Reset Form
					</button>				
									
				</div>
            </div>

            <!-- Preview Section -->
            <div>
                <div class="bg-gray-50 dark:bg-gray-800 p-8 rounded-lg shadow-custom mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-primary">Report Preview</h2>
					<div id="report-preview" class="bg-gradient-to-br from-gray-50 to-white dark:bg-gradient-to-br dark:from-gray-800 dark:to-gray-700 p-4 rounded-md min-h-[200px] overflow-auto">
						<div class="text-center text-gray-500 dark:text-gray-300 py-12">Your report preview will appear here.</div>
					</div>
                    <div id="pdf-controls" class="mt-4 text-center hidden">
                        <div class="flex justify-center space-x-4">
                            <button id="print-btn" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-secondary transition-colors flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2z" />
                                </svg>
                                Print Report
                            </button>
                        </div>
                        <p class="text-sm text-gray-600 dark:text-gray-300 dark:text-gray-400 mt-2">Opens a new window with the report for printing or saving as PDF</p>
                    </div>
                </div>
                
            </div>
        </div>
        
        <div class="bg-gray-50 dark:bg-gray-800 p-8 rounded-lg shadow-custom mt-6">
			<h2 class="text-xl font-semibold mb-4 text-primary">Saved Reports</h2>
			<div class="flex justify-between items-center">
					<button id="download-session-btn" class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors flex items-center">
						<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19V5m0 14l-4-4m4 4l4-4m-8 4h8"></path></svg>
						Download All Saved Data
					</button>
				
				</div>
			<div id="saved-reports-list" class="space-y-2">
				<p class="text-gray-500 dark:text-gray-300">No reports saved yet.</p>
			</div>
		</div>
        
        

    <!-- Print Container -->
    <div id="print-container" class="text-black">
        <!-- Report content will be added here when printing -->
        <button id="back-to-editor-btn" class="print-back-btn no-print hidden">Back to Editor</button>
    </div>

		<script>
		// Default club logo as a URL to the hosted PNG
		const defaultClubLogoSVG = 'https://melvinlhchow.github.io/LMPlayerReport/LMLogo.png';

		// Global variables
		let clubLogoData = null;
		let currentReportHTML = "";
		let playersData = [];
		let selectedPlayerData = null;
		let portraitImageData = null;
		let currentAttendanceData = null;
		let savedReports = [];
		let currentHeightGrowthData = [];
		let currentTotalGrowth = 0;
		let hasDownloadedSessionData = false;
		let ratingsLoadedFromFile = false; // Flag to track if ratings were loaded from a file
		let ratingsManuallyChanged = new Set(); // Track which sliders have been manually changed
		let cropper;
		let currentReportData = null;  // Store complete report data

		// Excel Column Mapping - Maps template columns to form field IDs
		const EXCEL_COLUMN_MAPPING = {
		  // === Basic Player Information ===
		  'First Name': 'manual-first-name',
		  'Last Name': 'manual-last-name',
		  'Date of Birth': 'manual-dob',
		  'Position': 'manual-position',
		  'Age Group': 'manual-age-group',
		  
		  // === Performance Ratings (14 metrics - v2 naming) ===
		  'Tactical - Attacking': 'tactical-attacking',
		  'Tactical - Defending': 'tactical-defending',
		  'Tactical - Transition Focus': 'tactical-transition',
		  'Technical - Fundamental': 'technical-fundamental',
		  'Technical - Execution': 'technical-execution',
		  'Technical - Decision Making': 'technical-decision',
		  'Physical - Speed': 'physical-speed',
		  'Physical - Agility': 'physical-agility',
		  'Physical - Coordination': 'physical-coordination',
		  'Physical - Endurance': 'physical-endurance',
		  'Social - Communication': 'social-communication',
		  'Social - Confidence': 'social-confidence',
		  'Social - Leadership': 'social-leadership',
		  'Social - Teamwork': 'social-teamwork',
		  
		  // === Attendance Data ===
		  'Total Training Sessions': 'total-training-sessions',
		  'Training Sessions Attended': 'training-sessions-attended',
		  'Total Training Minutes': 'total-training-minutes',
		  'Total Matches': 'total-matches',
		  'Matches Played': 'matches-played',
		  'Total Match Minutes': 'total-match-minutes',
		  'Match Minutes Played': 'match-minutes-played',
		  
		  // === Physical Measurements ===
		  'Height (cm)': 'player-height',
		  'Weight (kg)': 'player-weight',
		  '10M Sprint (s)': 'test-10m-sprint',
		  '30M Sprint (s)': 'test-30m-sprint',
		  'CMJ (cm)': 'test-cmj',
		  'Yo-Yo IR1': 'test-yoyo',
		  
		  // === Grade ===
		  'Current Grade': 'current-grade',
		  
		  // === Feedback & Goals ===
		  'Strengths': 'strengths-manual',
		  'Coach Feedback': 'coach-feedback-manual',
		  'Areas of Improvement': 'improvement-manual',
		  'Short-term Goal': 'shortgoal-manual',
		  'Long-term Goal': 'longgoal-manual',
		  
		  // === Signatures ===
		  'Coach 1 Name': 'coach1-name',
		  'Coach 1 Title': 'coach1-title',
		  'Coach 2 Name': 'coach2-name',
		  'Coach 2 Title': 'coach2-title',
		  'Technical Director': 'technical-director',
		  'Technical Director Title': 'technical-director-title'
		};

		// Track which template columns were found
		let templateColumnsFound = [];
		let templateColumnsMissing = [];





		// DOM elements (defined globally, initialized in DOMContentLoaded)
		const manualPlayerDataRadio = document.getElementById('manual-player-data');
		const filePlayerDataRadio = document.getElementById('file-player-data');
		const playerFileSection = document.getElementById('player-file-input');
		const playerManualInput = document.getElementById('player-manual-input');
		const xlsFileInput = document.getElementById('xlsFile');
		const portraitFileInput = document.getElementById('portraitFile');
		const clubLogoFileInput = document.getElementById('clubLogoFile');
		const playerSelectContainer = document.getElementById('playerSelectContainer');
		const playerSelect = document.getElementById('playerSelect');
		const generateBtn = document.getElementById('generate-btn');
		const resetBtn = document.getElementById('reset-btn');
		const reportPreview = document.getElementById('report-preview');
		const statusMessage = document.getElementById('status-message');
		const pdfControls = document.getElementById('pdf-controls');
		const printBtn = document.getElementById('print-btn');
		const manualFirstName = document.getElementById('manual-first-name');
		const manualLastName = document.getElementById('manual-last-name');
		const manualDob = document.getElementById('manual-dob');
		const manualPosition = document.getElementById('manual-position');
		const progressBarFill = document.getElementById('progress-bar-fill');
		const progressPercentageText = document.getElementById('progress-percentage');

		// Sliders array
		const sliders = [
			'tactical-attacking', 'tactical-defending', 'tactical-transition',
			'technical-fundamental', 'technical-execution', 'technical-decision',
			'physical-speed', 'physical-agility', 'physical-coordination', 'physical-endurance',
			'social-communication', 'social-confidence', 'social-leadership', 'social-teamwork'
		];

		document.addEventListener('DOMContentLoaded', () => {
			sliders.forEach(id => {
				const slider = document.getElementById(id);
				if (slider) {
					const valueDisplay = slider.parentElement.querySelector('.rating-value');
					if (valueDisplay) {
						// Set initial value
						valueDisplay.textContent = slider.value;

						// Update on change
						slider.addEventListener('input', (e) => {
							valueDisplay.textContent = e.target.value;
							updateMetricAverages(); // ← ADD THIS
							updateRadarChart();  // ← ADD THIS LINE
							updateProgress(); // ← ADD THIS
						});
					}
				}
			});
			
			// Call once on page load to set initial averages
			updateMetricAverages(); // ← ADD THIS
		});

			
		// Add this NEW function after the sliders array
		function updateMetricAverages() {
			// Get all current slider values
			const tacticalAttacking = parseInt(document.getElementById('tactical-attacking')?.value || '3');
			const tacticalDefending = parseInt(document.getElementById('tactical-defending')?.value || '3');
			const tacticalTransition = parseInt(document.getElementById('tactical-transition')?.value || '3');
			
			const technicalFundamental = parseInt(document.getElementById('technical-fundamental')?.value || '3');
			const technicalExecution = parseInt(document.getElementById('technical-execution')?.value || '3');
			const technicalDecision = parseInt(document.getElementById('technical-decision')?.value || '3');
			
			const physicalSpeed = parseInt(document.getElementById('physical-speed')?.value || '3');
			const physicalAgility = parseInt(document.getElementById('physical-agility')?.value || '3');
			const physicalCoordination = parseInt(document.getElementById('physical-coordination')?.value || '3');
			const physicalEndurance = parseInt(document.getElementById('physical-endurance')?.value || '3');
			
			const socialCommunication = parseInt(document.getElementById('social-communication')?.value || '3');
			const socialConfidence = parseInt(document.getElementById('social-confidence')?.value || '3');
			const socialLeadership = parseInt(document.getElementById('social-leadership')?.value || '3');
			const socialTeamwork = parseInt(document.getElementById('social-teamwork')?.value || '3');
			
			// Calculate averages
			const tacticalAvg = ((tacticalAttacking + tacticalDefending + tacticalTransition) / 3).toFixed(1);
			const technicalAvg = ((technicalFundamental + technicalExecution + technicalDecision) / 3).toFixed(1);
			const physicalAvg = ((physicalSpeed + physicalAgility + physicalCoordination + physicalEndurance) / 4).toFixed(1);
			const socialAvg = ((socialCommunication + socialConfidence + socialLeadership + socialTeamwork) / 4).toFixed(1);
			
			// Update the display using IDs directly
			const tacticalAvgEl = document.getElementById('tactical-avg');
			const technicalAvgEl = document.getElementById('technical-avg');
			const physicalAvgEl = document.getElementById('physical-avg');
			const socialAvgEl = document.getElementById('social-avg');

			if (tacticalAvgEl) tacticalAvgEl.textContent = tacticalAvg;
			if (technicalAvgEl) technicalAvgEl.textContent = technicalAvg;
			if (physicalAvgEl) physicalAvgEl.textContent = physicalAvg;
			if (socialAvgEl) socialAvgEl.textContent = socialAvg;
		}
			
		// Function definitions (moved above DOMContentLoaded)
		function formatExcelDate(serial) {
			if (!serial || isNaN(serial)) return 'N/A';
			const excelEpoch = new Date(Date.UTC(1899, 11, 31));
			const days = Math.floor(serial);
			const milliseconds = Math.round((serial - days) * 86400000);
			const date = new Date(excelEpoch.getTime() + (days * 86400000) + milliseconds);
			if (serial < 60) {
				date.setUTCDate(date.getUTCDate() - 1);
			}
			return date.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' });
		}



		function togglePlayerInput() {
			if (manualPlayerDataRadio.checked) {
				playerManualInput.classList.remove('hidden');
				playerFileSection.classList.add('hidden');
				playerSelectContainer.classList.add('hidden');
			} else {
				playerManualInput.classList.add('hidden');
				playerFileSection.classList.remove('hidden');
				playerSelectContainer.classList.remove('hidden');
			}
			updateGenerateButtonState();
			updateProgress();
		}

		function handleFileUpload(e) {
			const file = e.target.files[0];
			if (file) {
				const reader = new FileReader();
				reader.onload = (e) => {
					const data = new Uint8Array(e.target.result);
					const workbook = XLSX.read(data, { type: 'array' });
					const sheetName = workbook.SheetNames[0];
					const worksheet = workbook.Sheets[sheetName];
					playersData = XLSX.utils.sheet_to_json(worksheet);
					populatePlayerSelect();
					showStatus('Player data file uploaded successfully!', 'success');
				};
				reader.readAsArrayBuffer(file);
			}
		}

		function handleClubLogoUpload(e) {
			const file = e.target.files[0];
			if (file) {
				const reader = new FileReader();
				reader.onload = (e) => {
					clubLogoData = e.target.result;
					showStatus('Club logo uploaded successfully!', 'success');
				};
				reader.readAsDataURL(file);
			}
		}

		function populatePlayerSelect() {
			playerSelect.innerHTML = '<option value="">Select a player...</option>';
			playersData.forEach((player, index) => {
				const option = document.createElement('option');
				option.value = index;
				option.textContent = `${player['First Name'] || ''} ${player['Last Name'] || ''}`.trim() || 'Unnamed Player';
				playerSelect.appendChild(option);
			});
		}


		
		function updateGenerateButtonState() {
			const portraitFile = document.getElementById('portraitFile').value;
			const firstName = document.getElementById('manual-first-name').value.trim();
			const lastName = document.getElementById('manual-last-name').value.trim();

			let isValid = true;

			if (manualPlayerDataRadio.checked) {
				if (!firstName || !lastName || !portraitFile) {
					isValid = false;
				}
			} else {
				if (!playerSelect.value || !portraitFile) {
					isValid = false;
				}
			}

			generateBtn.disabled = !isValid;
			generateBtn.classList.toggle('disabled-btn', !isValid);
		}
		
		function toggleSection(header) {
			// Find the parent container of the header
			const parent = header.parentElement;
			// Find the .collapsible-content within the parent
			const content = parent.querySelector('.collapsible-content');
			if (content) {
				const isActive = content.classList.toggle('active');
				header.classList.toggle('active', isActive);
			}
		}

		function updateProgress() {
			let totalSections = 7; // Player Data, Height Growth, Attendance, Ratings, graders, Feedback, Signatures
			let completedSections = 0;

			// Player Data Progress
			let playerProgress = 'Not Started';
			const firstName = manualFirstName.value.trim();
			const lastName = manualLastName.value.trim();
			if (filePlayerDataRadio.checked) {
				if (playerSelect.value) {
					playerProgress = 'Completed';
					completedSections++;
				}
			} else {
				if (firstName && lastName && portraitImageData) {
					playerProgress = 'Completed';
					completedSections++;
				} else if (firstName || lastName || portraitImageData) {
					playerProgress = 'In Progress';
				}
			}
			document.getElementById('progress-player').textContent = playerProgress;
			document.getElementById('icon-player').className = `progress-icon ${playerProgress.toLowerCase().replace(' ', '-')}`;

			// Physical Data Progress
			let physicalProgress = 'Not Started';
			const height = document.getElementById('player-height')?.value;
			const weight = document.getElementById('player-weight')?.value;
			const sprint10m = document.getElementById('test-10m-sprint')?.value;
			const sprint30m = document.getElementById('test-30m-sprint')?.value;
			const cmj = document.getElementById('test-cmj')?.value;
			const yoyo = document.getElementById('test-yoyo')?.value;

			const physicalInputs = [height, weight, sprint10m, sprint30m, cmj, yoyo].filter(Boolean);

			// Consider complete if ANY physical data is entered
			if (physicalInputs.length > 0) {
				physicalProgress = 'Completed';
				completedSections++;
			}

			document.getElementById('progress-height').textContent = physicalProgress;
			document.getElementById('icon-height').className = `progress-icon ${physicalProgress.toLowerCase().replace(' ', '-')}`;

			// Attendance Progress
			let attendanceProgress = 'Not Started';
			const attendanceInputs = document.querySelectorAll('#attendance-manual-input input[type="number"]');
			const filledAttendanceInputs = Array.from(attendanceInputs).filter(input => parseInt(input.value) > 0);
			if (filledAttendanceInputs.length === attendanceInputs.length) {
				attendanceProgress = 'Completed';
				completedSections++;
			} else if (filledAttendanceInputs.length > 0) {
				attendanceProgress = 'In Progress';
			}
			document.getElementById('progress-attendance').textContent = attendanceProgress;
			document.getElementById('icon-attendance').className = `progress-icon ${attendanceProgress.toLowerCase().replace(' ', '-')}`;

			// Ratings Progress (always completed since all sliders have default value of 3)
			let ratingsProgress = 'Completed';
			completedSections++;

			document.getElementById('progress-ratings').textContent = ratingsProgress;
			document.getElementById('icon-ratings').className = `progress-icon ${ratingsProgress.toLowerCase().replace(' ', '-')}`;

			// Grades Progress
			let gradesProgress = 'Not Started';
			const currentGrade = document.getElementById('current-grade')?.value;
			if (currentGrade && currentGrade !== 'A') { // A is default
				gradesProgress = 'Completed';
				completedSections++;
			}
			document.getElementById('progress-grades').textContent = gradesProgress;
			document.getElementById('icon-grades').className = `progress-icon ${gradesProgress.toLowerCase().replace(' ', '-')}`;

			// Feedback Progress (with Strengths excluded if it's moved out)
			let feedbackProgress = 'Not Started';
			let feedbackSectionsComplete = 0;

			// Only check these four fields now:
			const feedbackFields = [
				{ tags: 'feedback-tags', manual: 'coach-feedback-manual' },
				{ tags: 'improvement-tags', manual: 'improvement-manual' },
				{ tags: 'shortgoal-tags', manual: 'shortgoal-manual' },
				{ tags: 'longgoal-tags', manual: 'longgoal-manual' }
			];

			feedbackFields.forEach(section => {
				const tagsContainer = document.getElementById(section.tags);
				const manualInput = document.getElementById(section.manual);
				const selectedTags = tagsContainer?.querySelectorAll('.preset-tag.selected').length || 0;
				const manualText = manualInput?.value.trim() || '';
				if (selectedTags > 0 || manualText !== '') {
					feedbackSectionsComplete++;
				}
			});

			if (feedbackSectionsComplete === feedbackFields.length) {
				feedbackProgress = 'Completed';
				completedSections++;
			} else if (feedbackSectionsComplete > 0) {
				feedbackProgress = 'In Progress';
			}
			document.getElementById('progress-feedback').textContent = feedbackProgress;
			document.getElementById('icon-feedback').className = `progress-icon ${feedbackProgress.toLowerCase().replace(' ', '-')}`;

																		
			
			// Signatures Progress (always completed since pre-filled with defaults)
			let signaturesProgress = 'Completed';
			completedSections++;

			document.getElementById('progress-signatures').textContent = signaturesProgress;
			document.getElementById('icon-signatures').className = `progress-icon ${signaturesProgress.toLowerCase().replace(' ', '-')}`;

			// Update overall progress
			const progressPercentage = Math.round((completedSections / totalSections) * 100);
			const progressBarFill = document.getElementById('progress-bar-fill');
			progressBarFill.style.width = `${progressPercentage}%`;
			document.getElementById('progress-percentage').textContent = `${progressPercentage}%`;
		}

		function updateProgressItem(section, isComplete) {
			const icon = document.getElementById(`icon-${section}`);
			const progressText = document.getElementById(`progress-${section}`);
			
			if (isComplete) {
				icon.textContent = '✅';
				icon.className = 'progress-icon mr-2 completed';
				progressText.textContent = 'Completed';
			} else {
				const hasData = checkSectionHasData(section);
				icon.textContent = hasData ? '🍊' : '⏳';
				icon.className = `progress-icon mr-2 ${hasData ? 'in-progress' : 'not-started'}`;
				progressText.textContent = hasData ? 'In Progress' : 'Not Started';
			}
		}
		
		function checkSectionHasData(section) {
		const monthKeys = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];
		switch (section) {
			case 'player':
				if (manualPlayerDataRadio.checked) {
					return manualFirstName.value || manualLastName.value || portraitImageData;
				} else {
					return !!selectedPlayerData || portraitImageData;
				}
			case 'attendance':
				const attendanceInputs = document.querySelectorAll('#attendance-manual-input input[type="number"]');
				return Array.from(attendanceInputs).some(input => input.value !== '' && parseInt(input.value) > 0);
			case 'ratings':
				return false; // Sliders always have a default value, so no "in progress" state
			case 'grades':
				return false; // Dropdowns always have a default value
			case 'feedback':
				


			case 'signatures':
				const coach1Name = document.getElementById('coach1-name').value;
				const coach2Name = document.getElementById('coach2-name').value;
				const technicalDirector = document.getElementById('technical-director').value;
				return coach1Name || coach2Name || technicalDirector;
			default:
				return false;
		}
	}
		

		function resetForm() {
			// Reset player data inputs
			document.getElementById('manual-first-name').value = '';
			document.getElementById('manual-last-name').value = '';
			document.getElementById('manual-dob').value = '';
			document.getElementById('manual-position').value = '';
			document.getElementById('portraitFile').value = '';
			portraitImageData = null;
			resetCropper(); // Add this to clean up cropper
			document.getElementById('clubLogoFile').value = '';
			clubLogoImageData = null; // Note: Your original code references clubLogoImageData, which seems to be a typo; should be clubLogoData
			document.getElementById('xlsFile').value = '';
			playerSelect.innerHTML = '<option value="">Select a player...</option>';
			playerSelectContainer.classList.add('hidden');
			playersData = [];
			selectedPlayerData = null;

			
			// Reset attendance inputs
			document.getElementById('total-training-sessions').value = '0';
			document.getElementById('training-sessions-attended').value = '0';
			document.getElementById('total-training-minutes').value = '0';
			document.getElementById('total-matches').value = '0';
			document.getElementById('matches-played').value = '0';
			document.getElementById('total-match-minutes').value = '0';
			document.getElementById('match-minutes-played').value = '0';

			// Reset sliders
			sliders.forEach(id => {
				const slider = document.getElementById(id);
				if (slider) {
					slider.value = '3';
					const valueDisplay = slider.parentElement.querySelector('.rating-value');
					if (valueDisplay) {
						valueDisplay.textContent = '3';
					}
				}
			});

			// Reset ratings flags
			ratingsLoadedFromFile = false;
			ratingsManuallyChanged.clear();

			// Reset grades
			document.getElementById('current-grade').value = 'A';



			// Reset signatures
			document.getElementById('coach1-name').value = 'Melvin Chow';
			document.getElementById('coach1-title').value = 'Coach';
			document.getElementById('coach2-name').value = 'Lee Hong Lim';
			document.getElementById('coach2-title').value = 'Coach';
			document.getElementById('technical-director').value = 'Tsang Chiu Tat';
			document.getElementById('technical-director-title').value = 'Technical Director';

			// Reset preview
			reportPreview.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-300 py-12">Your report preview will appear here.</div>';
			pdfControls.classList.add('hidden');

			updateGenerateButtonState();
			updateProgress();
			showStatus('Form has been reset.', 'info');
		}




		function generateReport() {
			try {
				showStatus('Generating report...', 'info');
				if (!portraitImageData) {
					showStatus('Please upload a player portrait before generating the report.', 'error');
					return;
				}

				let playerInfo;
				if (manualPlayerDataRadio.checked) {
					const firstName = manualFirstName.value.trim();
					const lastName = manualLastName.value.trim();
					if (!firstName && !lastName) {
						showStatus('Please enter a first name or last name for manual input.', 'error');
						return;
					}
					playerInfo = {
						firstName: firstName || 'Unknown',
						lastName: lastName || 'Player',
						sdob: manualDob.value ? new Date(manualDob.value).toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' }) : 'N/A',
						position: getCombinedText('position') || manualPosition.value || '',
						ageGroup: document.getElementById('manual-age-group')?.value || ''
					};
				} else if (selectedPlayerData) {
					playerInfo = {
						firstName: selectedPlayerData['First Name'] || 'Unknown',
						lastName: selectedPlayerData['Last Name'] || 'Player',
						sdob: formatExcelDate(selectedPlayerData['Date of Birth']),
						position: selectedPlayerData['Position'] || '',
						ageGroup: selectedPlayerData['Age Group'] || ''
					};
				} else {
					showStatus('No player data available to generate report.', 'error');
					return;
				}
	
				// Physical Data Collection
				const physicalData = {
					height: document.getElementById('player-height')?.value || 'N/A',
					weight: document.getElementById('player-weight')?.value || 'N/A',
					sprint10m: document.getElementById('test-10m-sprint')?.value || 'N/A',
					sprint30m: document.getElementById('test-30m-sprint')?.value || 'N/A',
					cmj: document.getElementById('test-cmj')?.value || 'N/A',
					yoyo: document.getElementById('test-yoyo')?.value || 'N/A'
				};

				// Physical Data HTML Section
				const physicalSectionHTML = `
					<div class="mb-8">
						<h3 class="font-bold text-xl mb-4 text-primary">Physical Data</h3>
						<div class="border rounded-lg p-4">

							<div class="grid grid-cols-2 gap-4 mb-4">
								<div class="text-sm"><h4>
									<span class="font-semibold mb-2">Height:</span>
									<span class="font-semibold ml-1">${physicalData.height} cm</span>
								</h4></div>
								<div class="text-sm"><h4>
									<span class="font-semibold mb-2">Weight:</span>
									<span class="font-semibold ml-1">${physicalData.weight} kg</span>
								</h4></div>
							</div>

							<h4 class="font-semibold mb-2">Physical Test Results</h4>
							<table class="w-full text-center border-collapse">
								<thead>
									<tr class="border-b">
										<th class="p-2 text-sm font-medium" style="width: 25%;">10M Sprint</th>
										<th class="p-2 text-sm font-medium" style="width: 25%;">30M Sprint</th>
										<th class="p-2 text-sm font-medium" style="width: 25%;">CMJ</th>
										<th class="p-2 text-sm font-medium" style="width: 25%;">Yo-Yo IR1</th>
									</tr>
								</thead>
								<tbody>
									<tr>
										<td class="p-2 text-sm font-semibold">${physicalData.sprint10m}s</td>
										<td class="p-2 text-sm font-semibold">${physicalData.sprint30m}s</td>
										<td class="p-2 text-sm font-semibold">${physicalData.cmj}cm</td>
										<td class="p-2 text-sm font-semibold">Level ${physicalData.yoyo}</td>
									</tr>
								</tbody>
							</table>
						</div>
					</div>
				`;

				const attendanceData = {
					training: {
						totalSessions: parseInt(document.getElementById('total-training-sessions')?.value || 0),
						sessionsAttended: parseInt(document.getElementById('training-sessions-attended')?.value || 0),
						totalMinutes: parseInt(document.getElementById('total-training-minutes')?.value || 0)
					},
					match: {
						totalMatches: parseInt(document.getElementById('total-matches')?.value || 0),
						matchesPlayed: parseInt(document.getElementById('matches-played')?.value || 0),
						totalMinutes: parseInt(document.getElementById('total-match-minutes')?.value || 0),
						minutesPlayed: parseInt(document.getElementById('match-minutes-played')?.value || 0)
					}
				};

				const trainingAttendancePercentage = attendanceData.training.totalSessions > 0 
					? (attendanceData.training.sessionsAttended / attendanceData.training.totalSessions * 100).toFixed(1) 
					: 0;
				const matchMinutesPercentage = attendanceData.match.totalMinutes > 0 
					? (attendanceData.match.minutesPlayed / attendanceData.match.totalMinutes * 100).toFixed(1) 
					: 0;

				// NEW 14 Metrics Collection
				const ratings = {
					tacticalAttacking: parseInt(document.getElementById('tactical-attacking')?.value || '3'),
					tacticalDefending: parseInt(document.getElementById('tactical-defending')?.value || '3'),
					tacticalTransition: parseInt(document.getElementById('tactical-transition')?.value || '3'),
					technicalFundamental: parseInt(document.getElementById('technical-fundamental')?.value || '3'),
					technicalExecution: parseInt(document.getElementById('technical-execution')?.value || '3'),
					technicalDecision: parseInt(document.getElementById('technical-decision')?.value || '3'),
					physicalSpeed: parseInt(document.getElementById('physical-speed')?.value || '3'),
					physicalAgility: parseInt(document.getElementById('physical-agility')?.value || '3'),
					physicalCoordination: parseInt(document.getElementById('physical-coordination')?.value || '3'),
					physicalEndurance: parseInt(document.getElementById('physical-endurance')?.value || '3'),
					socialCommunication: parseInt(document.getElementById('social-communication')?.value || '3'),
					socialConfidence: parseInt(document.getElementById('social-confidence')?.value || '3'),
					socialLeadership: parseInt(document.getElementById('social-leadership')?.value || '3'),
					socialTeamwork: parseInt(document.getElementById('social-teamwork')?.value || '3')
				};

				// Category Averages (for future use)
				const tacticalAvg = ((ratings.tacticalAttacking + ratings.tacticalDefending + ratings.tacticalTransition) / 3).toFixed(1);
				const technicalAvg = ((ratings.technicalFundamental + ratings.technicalExecution + ratings.technicalDecision) / 3).toFixed(1);
				const physicalAvg = ((ratings.physicalSpeed + ratings.physicalAgility + ratings.physicalCoordination + ratings.physicalEndurance) / 4).toFixed(1);
				const socialAvg = ((ratings.socialCommunication + ratings.socialConfidence + ratings.socialLeadership + ratings.socialTeamwork) / 4).toFixed(1);




				const coach1Name = document.getElementById('coach1-name')?.value || 'Melvin Chow';
				const coach1Title = document.getElementById('coach1-title')?.value || 'Coach';
				const coach2Name = document.getElementById('coach2-name')?.value || 'Lee Hong Lim';
				const coach2Title = document.getElementById('coach2-title')?.value || 'Coach';
				const technicalDirector = document.getElementById('technical-director')?.value || 'Tsang Chiu Tat';
				const technicalDirectorTitle = document.getElementById('technical-director-title')?.value || 'Technical Director';
				// Grades and Feedback with Tag-based Fields
				const currentGrade = document.getElementById('current-grade')?.value || 'A';
				const strengths = getCombinedText('strengths');
				const coachFeedback = getCombinedText('feedback');
				const areasImprovement = getCombinedText('improvement');
				const shortTermGoal = getCombinedText('shortgoal');
				const longTermGoal = getCombinedText('longgoal');
				const gradeStyles = {
					'A+': 'bg-green-200 text-green-800 font-semibold',
					'A': 'bg-green-200 text-green-800 font-semibold',
					'A-': 'bg-green-200 text-green-800 font-semibold',
					'B+': 'bg-lime-200 text-lime-800 font-semibold',
					'B': 'bg-lime-200 text-lime-800 font-semibold',
					'B-': 'bg-lime-200 text-lime-800 font-semibold',
					'C+': 'bg-yellow-200 text-yellow-800 font-semibold',
					'C': 'bg-yellow-200 text-yellow-800 font-semibold',
					'C-': 'bg-yellow-200 text-yellow-800 font-semibold',
					'D': 'bg-orange-200 text-orange-800 font-semibold',
					'E': 'bg-red-200 text-red-800 font-semibold'
				};
				const currentGradeStyle = gradeStyles[currentGrade] || 'bg-gray-200 text-gray-800';


				let clubLogoHTML = clubLogoData 
					? `<img src="${clubLogoData}" alt="Club Logo" class="w-24 h-auto max-h-24">`
					: `<img src="${defaultClubLogoSVG}" alt="Club Logo" class="w-24 h-auto max-h-24">`;
				let portraitHTML = portraitImageData 
					? `<img src="${portraitImageData}" alt="Player Portrait" class="w-full h-full object-cover">` 
					: '<div class="w-full h-full bg-gray-200 flex items-center justify-center"><span class="text-gray-500">No Photo</span></div>';

				
				let positionHTML = playerInfo.position ? `<p class="text-base text-black dark:text-black">Position: ${playerInfo.position}</p>` : '';
				// Store complete report data for printing
				currentReportData = {
					tacticalAvg: tacticalAvg,
					technicalAvg: technicalAvg,
					physicalAvg: physicalAvg,
					socialAvg: socialAvg
				};
				const reportHTML = `
					<div class="bg-white text-black p-8 print:p-[0.5cm] w-full max-w-[19cm] mx-auto" id="report-container" style="height: auto; overflow: visible; page-break-inside: auto; break-inside: auto;">
						<div class="mb-6 border-b-2 border-primary pb-4">
							<div class="mb-4 w-full">
							  <div class="flex flex-col items-center justify-center mb-2">
								<div class="mb-2">
								  ${clubLogoHTML.replace(
									'style="max-width: 200px; height: auto;"',
									'style="max-width: 100px; max-height: 100px; height: auto;"'
								  )}
								</div>
								<h1 class="text-3xl font-bold text-primary text-center">
								  Academy Player Development Report
								</h1>
							  </div>
							</div>
						<div class="grid grid-cols-4 gap-4">
								<div class="col-span-3">
									<h2 class="text-xl font-bold text-black dark:text-black">${playerInfo.firstName} ${playerInfo.lastName}</h2>
									<p class="text-base text-black dark:text-black">Date of Birth: ${playerInfo.sdob}</p>
									${positionHTML}
									${playerInfo.ageGroup ? `<p class="text-base text-black dark:text-black">Age Group: ${playerInfo.ageGroup}</p>` : ''}
									<p class="text-base text-black dark:text-black">Review Date: ${new Date().toLocaleDateString()}</p>
								</div>

								<div class="col-span-1">
									<div class="w-32 h-32 overflow-hidden rounded-full">${portraitHTML}</div>
								</div>
							</div>
						</div>
										
						${physicalSectionHTML}
						
						<div class="mb-8">
							<h3 class="font-bold text-xl mb-4 text-primary">Player Attendance</h3>
							<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
								<div class="border rounded-lg p-2">
									<h4 class="font-bold text-lg mb-3">Training Attendance</h4>
									<div class="space-y-2">
										<div class="flex justify-between"><span>Total Training Sessions:</span><span class="font-medium">${attendanceData.training.totalSessions}</span></div>
										<div class="flex justify-between"><span>Sessions Attended:</span><span class="font-medium">${attendanceData.training.sessionsAttended}</span></div>
										<div class="flex justify-between"><span>Total Training Minutes:</span><span class="font-medium">${attendanceData.training.totalMinutes}</span></div>
										<div class="flex justify-between text-primary font-semibold mt-2 pt-2 border-t"><span>Attendance Rate:</span><span>${trainingAttendancePercentage}%</span></div>
										<div class="w-full bg-gray-200 rounded-full h-2.5 mt-1"><div class="bg-gradient-to-r from-primary to-secondary h-2.5 rounded-full progress-fill" style="--progress-width: ${trainingAttendancePercentage}%; width: ${trainingAttendancePercentage}%"></div></div>
									</div>
								</div>
								<div class="border rounded-lg p-2">
									<h4 class="font-bold text-lg mb-3">Match Clock</h4>
									<div class="space-y-2">
										<div class="flex justify-between"><span>Total Matches:</span><span class="font-medium">${attendanceData.match.totalMatches}</span></div>
										<div class="flex justify-between"><span>Played:</span><span class="font-medium">${attendanceData.match.matchesPlayed}</span></div>
										<div class="flex justify-between"><span>Total Minutes:</span><span class="font-medium">${attendanceData.match.totalMinutes}</span></div>
										<div class="flex justify-between text-primary font-semibold mt-2 pt-2 border-t"><span>Minutes Played:</span><span>${attendanceData.match.minutesPlayed} (${matchMinutesPercentage}%)</span></div>
										<div class="w-full bg-gray-200 rounded-full h-2.5 mt-1"><div class="bg-gradient-to-r from-primary to-secondary h-2.5 rounded-full progress-fill" style="--progress-width: ${matchMinutesPercentage}%; width: ${matchMinutesPercentage}%"></div></div>
									</div>
								</div>
							</div>
						</div>
						<div class="mb-6">
							<h3 class="font-bold text-xl mb-4 text-primary">Player Evaluation</h3>
							<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
								
								<!-- Radar Chart - Fixed size -->

								
								
								<div class="border rounded-lg p-3">
									<h4 class="font-bold text-lg mb-3">Player Evaluation Radar</h4>
									<div class="radar-wrapper flex justify-center items-center" style="height: 220px;">
										<div style="width: 280px; height: 200px;">
											<canvas id="skills-radar"></canvas>
										</div>
									</div>
								</div>
																
								
								<!-- Player Grades - Match height -->
								<div class="border rounded-lg p-3 flex flex-col justify-between" style="min-height: 220px;">
								  <div>
									<h4 class="font-bold text-lg mb-3">Player Grades</h4>

									<div class="mb-4">
									  <span class="block font-semibold text-sm mb-1">Current Grade:</span>
									  <div class="w-full">
										<span class="block w-full text-center text-2xl py-2 rounded-full ${gradeStyles[currentGrade] || 'bg-gray-200 text-gray-800'}">
										  ${currentGrade}
										</span>
									  </div>
									</div>

									${strengths ? `
									  <div>
										<h4 class="font-semibold text-sm mb-1">Strengths:</h4>
										<p class="text-gray-700">${strengths}</p>
									  </div>
									` : ''}
								  </div>
								</div>
								
							</div>
						</div>


						<div class="mb-8" style="page-break-before: always;padding-top: 3rem;">
							<h3 class="font-bold text-xl mb-4 text-primary">Performance Metrics</h3>
							<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
								<!-- Tactical (3) -->
								<div class="border rounded-lg p-4 flex flex-col min-h-[170px]">
									<h4 class="font-bold text-lg mb-3">Tactical (${tacticalAvg})</h4>
									<div class="space-y-2 flex-1 flex flex-col justify-between">
										${createRatingBar('Attacking', ratings.tacticalAttacking)}
										${createRatingBar('Defending', ratings.tacticalDefending)}
										${createRatingBar('Transition Focus', ratings.tacticalTransition)}
									</div>
								</div>

								<!-- Technical (3) -->
								<div class="border rounded-lg p-4 flex flex-col min-h-[170px]">
									<h4 class="font-bold text-lg mb-3">Technical (${technicalAvg})</h4>
									<div class="space-y-2 flex-1 flex flex-col justify-between">
										${createRatingBar('Fundamental', ratings.technicalFundamental)}
										${createRatingBar('Execution', ratings.technicalExecution)}
										${createRatingBar('Decision Making', ratings.technicalDecision)}
									</div>
								</div>

								<!-- Physical (4) -->
								<div class="border rounded-lg p-4 flex flex-col min-h-[170px]">
									<h4 class="font-bold text-lg mb-3">Physical (${physicalAvg})</h4>
									<div class="space-y-2 flex-1 flex flex-col justify-between">
										${createRatingBar('Speed', ratings.physicalSpeed)}
										${createRatingBar('Agility', ratings.physicalAgility)}
										${createRatingBar('Coordination', ratings.physicalCoordination)}
										${createRatingBar('Endurance', ratings.physicalEndurance)}
									</div>
								</div>

								<!-- Social (4) -->
								<div class="border rounded-lg p-4 flex flex-col min-h-[170px]">
									<h4 class="font-bold text-lg mb-3">Social (${socialAvg})</h4>
									<div class="space-y-2 flex-1 flex flex-col justify-between">
										${createRatingBar('Communication', ratings.socialCommunication)}
										${createRatingBar('Confidence', ratings.socialConfidence)}
										${createRatingBar('Leadership', ratings.socialLeadership)}
										${createRatingBar('Teamwork', ratings.socialTeamwork)}
									</div>
								</div>
							</div>

						</div>


						<div class="mb-8">
							<h3 class="font-bold text-xl mb-4 text-primary">Feedback & Development Goals</h3>
							<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
								
								${coachFeedback ? `
								<div class="border rounded-lg p-4">
									<h4 class="font-semibold mb-2 text-700">Coach Feedback:</h4>
									<p class="text-gray-700">${coachFeedback}</p>
								</div>
								` : ''}
								
								${areasImprovement ? `
								<div class="border rounded-lg p-4">
									<h4 class="font-semibold mb-2 text-700">Areas of Improvement:</h4>
									<p class="text-gray-700">${areasImprovement}</p>
								</div>
								` : ''}
								
								${shortTermGoal ? `
								<div class="border rounded-lg p-4">
									<h4 class="font-semibold mb-2 text-700">Short-term Goal:</h4>
									<p class="text-gray-700">${shortTermGoal}</p>
								</div>
								` : ''}
								
								${longTermGoal ? `
								<div class="border rounded-lg p-4">
									<h4 class="font-semibold mb-2 text-700">Long-term Goal:</h4>
									<p class="text-gray-700">${longTermGoal}</p>
								</div>
								` : ''}
								
							</div>
						</div>
						<div class="mt-6 mb-4 signature-section">
							<div class="flex flex-wrap justify-between">
								<div class="text-center mx-2 mb-2"><div class="signature-line"></div><p class="mt-1 text-base">${coach1Name}</p><p class="text-sm text-gray-600 dark:text-gray-300">${coach1Title}</p></div>
								<div class="text-center mx-2 mb-2"><div class="signature-line"></div><p class="mt-1 text-base">${coach2Name}</p><p class="text-sm text-gray-600 dark:text-gray-300">${coach2Title}</p></div>
								<div class="text-center mx-2 mb-2"><div class="signature-line"></div><p class="mt-1 text-base">${technicalDirector}</p><p class="text-sm text-gray-600 dark:text-gray-300">${technicalDirectorTitle}</p></div>
							</div>
						</div>
						<div class="text-center text-sm text-gray-500 border-t-2 border-gray-200 pt-2 mt-4">
							<p>Lee Man Football Club - Academy Player Development Report</p>
							<p>Generated on ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}</p>
						</div>
					</div>
				`;

				currentReportHTML = reportHTML;
				currentAttendanceData = attendanceData;
				reportPreview.innerHTML = reportHTML;
				// Initialize radar chart after report is rendered
				setTimeout(() => {
					updateRadarChart();
				}, 100);
				pdfControls.classList.remove('hidden');

				const playerName = `${playerInfo.firstName} ${playerInfo.lastName}`;
				const reportData = getCurrentSessionData();
				const reportEntry = {
					name: playerName,
					html: reportHTML,
					data: reportData,
					timestamp: new Date().toISOString()
				};
				savedReports.push(reportEntry);
				updateSavedReportsList();




				showStatus('Report generated and saved successfully!', 'success');
			} catch (error) {
				console.error('Error in generateReport:', error);
				showStatus('Error generating report: ' + error.message, 'error');
			}
		}

		function createRatingBar(label, value) {
			const filledStars = '★'.repeat(value);
			const emptyStars = '☆'.repeat(5 - value);
			
			return `
				<div style="display: flex; justify-content: space-between; align-items: center; margin: 4px 0; gap: 8px;">
					<span style="flex: 1 1 auto; font-size: 16pt min-width: 0;">${label}</span>
					<span style="flex: 0 0 auto; display: inline-flex; align-items: center; color: #FFD700; font-size: 16pt; letter-spacing: 1px; white-space: nowrap;">${filledStars}${emptyStars}</span>
					<span style="flex: 0 0 auto; font-size: 1rem; font-weight: 600; min-width: 30px; text-align: right;">${value}/5</span>
				</div>
			`;
		}

		function showStatus(message, type) {
		  statusMessage.textContent = message;
		  statusMessage.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800', 'bg-blue-100', 'text-blue-800', 'bg-yellow-100', 'text-yellow-800');
		  
		  switch (type) {
			case 'success':
			  statusMessage.classList.add('bg-green-100', 'text-green-800');
			  break;
			case 'error':
			  statusMessage.classList.add('bg-red-100', 'text-red-800');
			  break;
			case 'warning':
			  statusMessage.classList.add('bg-yellow-100', 'text-yellow-800');
			  break;
			case 'info':
			default:
			  statusMessage.classList.add('bg-blue-100', 'text-blue-800');
			  break;
		  }
		  
		  // Auto-hide after 8 seconds for warnings, 5 seconds for others
		  const hideDelay = type === 'warning' ? 8000 : 5000;
		  
		  if (type !== 'error') {
			setTimeout(() => {
			  statusMessage.classList.add('hidden');
			}, hideDelay);
		  }
		}


		function preparePrintView() {
			if (!currentReportHTML) {
				showStatus('Please generate a report first before printing.', 'error');
				return;
			}

			try {
				const printWindow = window.open('', '_blank', 'width=1000,height=800');
				if (!printWindow) {
					showStatus('Failed to open print window. Please allow pop-ups.', 'error');
					return;
				}

				// ✅ Modify the HTML directly before printing
				let printableHTML = currentReportHTML;
				// NEW: Recalculate attendance percentages for use in print window
				const totalTrainingSessions = parseInt(document.getElementById('total-training-sessions')?.value || '0', 10);
				const sessionsAttended     = parseInt(document.getElementById('training-sessions-attended')?.value || '0', 10);
				const totalTrainingMinutes = parseInt(document.getElementById('total-training-minutes')?.value || '0', 10);

				const totalMatches         = parseInt(document.getElementById('total-matches')?.value || '0', 10);
				const matchesPlayed        = parseInt(document.getElementById('matches-played')?.value || '0', 10);
				const totalMatchMinutes    = parseInt(document.getElementById('total-match-minutes')?.value || '0', 10);
				const matchMinutesPlayed   = parseInt(document.getElementById('match-minutes-played')?.value || '0', 10);

				// Same logic as generateReport
				const trainingAttendancePercentage =
					totalTrainingSessions > 0
						? ((sessionsAttended / totalTrainingSessions) * 100).toFixed(1)
						: '0.0';

				const matchMinutesPercentage =
					totalMatchMinutes > 0
						? ((matchMinutesPlayed / totalMatchMinutes) * 100).toFixed(1)
						: '0.0';

								
								
				// Fix 1: Ensure portrait container has inline styles for print
				printableHTML = printableHTML.replace(
					/<div class="w-28 h-28 overflow-hidden rounded-full">/g,
					'<div style="width: 112px; height: 112px; overflow: hidden; border-radius: 50%;">'
				);
				
				// Fix 2: Ensure portrait image has inline styles
				printableHTML = printableHTML.replace(
					/alt="Player Portrait" class="w-full h-full object-cover"/g,
					'alt="Player Portrait" style="width: 100%; height: 100%; object-fit: cover;"'
				);
				
				// Fix 3: Ensure club logo has proper size
				printableHTML = printableHTML.replace(
					/alt="Club Logo" class="w-full h-auto"/g,
					'alt="Club Logo" style="max-width: 80px; max-height: 80px; width: auto; height: auto;"'
				);

				// Fix 4: Force all grids to display as 2-column with inline styles
				printableHTML = printableHTML.replace(
					/<div class="grid grid-cols-1 md:grid-cols-2 gap-4">/g,
					'<div style="display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 0.3rem;">'
				);

				// Fix 5: Also catch any grid-2x2 classes
				printableHTML = printableHTML.replace(
					/<div class="grid-2x2 gap-4">/g,
					'<div style="display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 0.3rem;">'
				);

				// Fix 6: Catch grids with different gap sizes
				printableHTML = printableHTML.replace(
					/<div class="grid grid-cols-1 md:grid-cols-2 gap-6">/g,
					'<div style="display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 0.6rem;">'
				);

				// Fix 6b: Catch grid without gap specified
				printableHTML = printableHTML.replace(
					/<div class="grid grid-cols-1 md:grid-cols-2">/g,
					'<div style="display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 0.3rem;">'
				);

				// Fix 6c: Catch grid with mb- classes (margin-bottom)
				printableHTML = printableHTML.replace(
					/<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">/g,
					'<div style="display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 0.3rem; margin-bottom: 1rem;">'
				);

				// Fix 6d: Nuclear option - catch ANY div with "grid" and "md:grid-cols-2"
				printableHTML = printableHTML.replace(
					/<div class="([^"]*\bgrid\b[^"]*\bmd:grid-cols-2\b[^"]*)">/g,
					'<div style="display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 0.3rem;">'
				);


				// Fix 7: Add page break before Performance Metrics section
				printableHTML = printableHTML.replace(
					/<h2 class="text-2xl font-bold text-primary mb-6">Performance Metrics<\/h2>/g,
					'<div style="page-break-before: always;"></div><h2 class="text-2xl font-bold text-primary mb-6">Performance Metrics</h2>'
				);

				
				// Fix 8: Align star ratings - add wrapper with flexbox
				printableHTML = printableHTML.replace(
					/<div class="flex justify-between items-center mb-2">/g,
					'<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">'
				);

				// Fix 9: Ensure rating container is properly aligned
				printableHTML = printableHTML.replace(
					/<div class="flex items-center gap-2">/g,
					'<div style="display: flex; align-items: center; gap: 0.5rem;">'
				);

				// Fix 10: Star container alignment
				printableHTML = printableHTML.replace(
					/<span class="text-yellow-400">/g,
					'<span style="display: inline-flex; align-items: center; color: #FFD700;">'
				);





				// ✅ NEW: Convert rendered canvas to image BEFORE print window opens
				const canvasElement = document.getElementById('skills-radar');
				let chartImageDataURL = null;

				if (canvasElement) {
					try {
						chartImageDataURL = canvasElement.toDataURL('image/png');
						console.log('✓ Chart converted to image successfully');
					} catch (err) {
						console.warn('Could not convert canvas to image:', err);
					}
				}

				// Build complete print HTML
				const printHTML = `<!DOCTYPE html>

		<html lang="en">
		<head>
			<meta charset="UTF-8">
			<meta name="viewport" content="width=device-width, initial-scale=1.0">
			<title>Player Development Report - Print</title>
			
			<!-- ✅ FIX 1: Load Google Fonts directly -->
			<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
			
			<!-- Chart.js for radar chart -->
			<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"><\/script>
			
			<!-- Tailwind CSS -->
			<script src="https://cdn.tailwindcss.com"><\/script>
			
			<style>
				/* ✅ FIX 2: Set font family explicitly */
				* {
					font-family: 'Poppins', sans-serif !important;
				}
				
				/* Print-specific styles */
				@page {
					size: A4;
					margin: 0.5cm;
				}
				
				html, body {
					margin: 0;
					padding: 0;
					width: 100%;
					height: auto;
					font-family: 'Poppins', sans-serif !important;
				}
				
				body {
					padding: 0.5cm;
					font-size: 16px !important;
					line-height: 1.3 !important;
				}
				
				/* Compress spacing for 2-page fit */
				.mb-8, .my-8 { margin-bottom: 0.8rem !important; }
				.mb-6, .my-6 { margin-bottom: 0.6rem !important; }
				.mb-4, .my-4 { margin-bottom: 0.4rem !important; }
				.p-4 { padding: 0.5rem !important; }
				.p-2 { padding: 0.3rem !important; }
				.gap-6 { gap: 0.6rem !important; }
				.gap-4 { gap: 0.4rem !important; }
				
				/* Smaller headings */
				h1 { font-size: 24px !important; margin-bottom: 0.3rem !important; }
				h2 { font-size: 20px !important; margin-bottom: 0.3rem !important; }
				h3 { font-size: 18px !important; margin-bottom: 0.3rem !important; }
				h4 { font-size: 16px !important; margin-bottom: 0.2rem !important; }

				
				/* Compact performance metrics */
				.border.rounded-lg { padding: 0.4rem !important; }
				
				/* Fix table column spacing in print */
				table th,
				table td {
					text-align: center !important;
				}

				table th {
					width: 25% !important;
				}

				table.border-collapse {
					table-layout: fixed !important;
					width: 100% !important;
				}
				
				/* ✅ FIX 3: Preserve colors explicitly */
				* {
					print-color-adjust: exact !important;
					-webkit-print-color-adjust: exact !important;
					color-adjust: exact !important;
				}
				
				/* Ensure primary color (teal) is preserved */
				.text-primary {
					color: #FFD700 !important;
				}
				
				.border-primary {
					border-color: #FFD700 !important;
				}
				
				.bg-primary {
					background-color: #FFD700 !important;
				}
				
				.border-b-2.border-primary {
					border-bottom: 2px solid #FFD700 !important;
				}
				
				/* Tailwind primary color override */
				.from-primary {
					--tw-gradient-from: #FFD700 !important;
				}

				.to-secondary {
					--tw-gradient-to: #E6C200 !important;
				}
				/* Force radar chart to be centered in print */
					.radar-wrapper {
						display: flex !important;
						justify-content: center !important;
						align-items: center !important;
					}

					#skills-radar,
					.radar-wrapper img {
						display: block !important;
						margin-left: auto !important;
						margin-right: auto !important;
					}
				@media print {
					body {
						padding: 0.3cm;
					}
					
					.no-print {
						display: none !important;
					}
					
					
					
					/* Restore borders we want */
					.border {
						border: 1px solid rgba(94, 82, 64, 0.2) !important;
					}
					
					.border-b {
						border-bottom: 1px solid rgba(94, 82, 64, 0.2) !important;
					}
					
					.border-b-2 {
						border-bottom: 2px solid #FFD700 !important;
					}
					
					.rounded-lg {
						border: 1px solid rgba(94, 82, 64, 0.15) !important;
						border-radius: 8px !important;
					}
					
					/* Prevent breaks inside elements */
					.border.rounded-lg,
					.card,
					.grid > div {
						page-break-inside: avoid;
					}
					
					/* ✅ FIX: Force 2-column grid layout in print */
					.grid-2x2,
					.grid.grid-cols-1,
					.grid.md\:grid-cols-2,
					.grid-cols-1.md\:grid-cols-2 {
						display: grid !important;
						grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
						gap: 0.3rem !important;
					}
					
					/* Ensure grid items don't break */
					.grid-2x2 > *,
					.grid.grid-cols-1 > *,
					.grid.md\:grid-cols-2 > * {
						page-break-inside: avoid !important;
						break-inside: avoid !important;
					}
					
					/* Force all grids to maintain layout */
					.grid {
						display: grid !important;
					}
					
					/* Force Tailwind breakpoint overrides */
					.md\:grid-cols-2 {
						grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
					}
					.signature-section {
						page-break-before: auto !important;
						break-before: auto !important;
						margin-top: 3cm !important; /* keep if you like the vertical gap */
						max-height: none !important; /* allow full height */
						font-size: 9pt !important;   /* or remove this line entirely */
					}
					css
					/* Force radar chart to be centered in print */
					.radar-wrapper {
						display: flex !important;
						justify-content: center !important;
						align-items: center !important;
					}

					#skills-radar,
					.radar-wrapper img {
						display: block !important;
						margin-left: auto !important;
						margin-right: auto !important;
					}
				}
				.signature-line {
					width: 150px;
					height: 2px;
					background: black;
					margin: 0 auto 6px;
				}
				
				  
			</style>
		</head>
		<body>
			${printableHTML}
			
			<!-- ✅ FIX 4: Change button color from green (#FFD700) to teal (#21808d) -->
			<div class="no-print" style="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); text-align: center; padding: 20px; background: white; border: 2px solid #ddd; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 9999;">
				<button onclick="window.print()" style="padding: 12px 24px; background: #FFD700; color: black; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; margin-right: 10px;">
					Print / Save as PDF
				</button>
				<button onclick="window.close()" style="padding: 12px 24px; background: #6b7280; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600;">
					Close
				</button>
			</div>
			
			<script>
				// ✅ If we have a chart image from parent window, use it instead of redrawing
				const chartImageDataURL = '${chartImageDataURL}';
				
				if (chartImageDataURL && chartImageDataURL !== 'null') {
					// Replace canvas with image on page load
					window.addEventListener('load', function() {
						const canvasElement = document.getElementById('skills-radar');
						if (canvasElement) {
							const img = document.createElement('img');
							img.src = chartImageDataURL;
							img.alt = 'Player Evaluation Chart';
							img.style.maxWidth = '100%';
							img.style.height = 'auto';
							img.style.display = 'block';
							
							if (canvasElement.parentElement) {
								canvasElement.parentElement.replaceChild(img, canvasElement);
								console.log('✓ Chart canvas replaced with image');
							}
						}
					});
				} else {
					// Fallback: If no image available, try to render (your original code)
					console.warn('No chart image available, attempting to render');
					
					// Helper function - copy from your main code
					function getInputIdForMetric(metricName) {
						const mapping = {
							'Attacking': 'tactical-attacking',
							'Defending': 'tactical-defending',
							'Transition Focus': 'tactical-transition',
							'Fundamental': 'technical-fundamental',
							'Execution': 'technical-execution',
							'Decision Making': 'technical-decision',
							'Speed': 'physical-speed',
							'Agility': 'physical-agility',
							'Coordination': 'physical-coordination',
							'Endurance': 'physical-endurance',
							'Communication': 'social-communication',
							'Confidence': 'social-confidence',
							'Leadership': 'social-leadership',
							'Teamwork': 'social-teamwork'
						};
						return mapping[metricName];
					}

					// Complete updateRadarChart function - copy from your main code
					function updateRadarChart() {
						const canvasElement = document.getElementById('skills-radar');
						if (!canvasElement) {
							console.error('Canvas not found');
							return;
						}
						
						const ctx = canvasElement.getContext('2d');
						if (!ctx) {
							console.error('Context not found');
							return;
						}
						
						// Ensure canvas has explicit dimensions with high DPI support (high‑res for print)
						const container     = canvasElement.parentElement;
						const baseCssWidth  = 280;  // fixed width for print
						const baseCssHeight = 200;

						// 2x internal resolution for a sharper printed chart
						const scaleFactor = 3;
						const cssWidth  = baseCssWidth;
						const cssHeight = baseCssHeight;
						const dpr       = scaleFactor;

						canvasElement.width  = cssWidth * dpr;
						canvasElement.height = cssHeight * dpr;

						// Reset transform then scale
						ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

						canvasElement.style.width  = cssWidth + 'px';
						canvasElement.style.height = cssHeight + 'px';
						canvasElement.style.display = 'block';
						canvasElement.style.margin  = '0 auto';


						
						// Clear canvas
						ctx.fillStyle = '#ffffff';
						ctx.fillRect(0, 0, cssWidth, cssHeight);
						
						// Chart configuration
						const centerX = cssWidth / 2;
						const centerY = cssHeight / 2;
						const maxRadius = 95;
						const radiusScale = maxRadius / 5;
						const sliceAngle = (Math.PI * 2) / 14;
						
						// Metrics with shortened labels
						const metricsOrder = [
							{ name: 'Attacking', short: 'Att.', category: 'tactical' },
							{ name: 'Defending', short: 'Def.', category: 'tactical' },
							{ name: 'Transition Focus', short: 'Trans.', category: 'tactical' },
							{ name: 'Speed', short: 'Spd.', category: 'physical' },
							{ name: 'Agility', short: 'Agi.', category: 'physical' },
							{ name: 'Coordination', short: 'Coord.', category: 'physical' },
							{ name: 'Endurance', short: 'End.', category: 'physical' },
							{ name: 'Communication', short: 'Comm.', category: 'social' },
							{ name: 'Confidence', short: 'Conf.', category: 'social' },
							{ name: 'Leadership', short: 'Lead.', category: 'social' },
							{ name: 'Teamwork', short: 'Team.', category: 'social' },
							{ name: 'Fundamental', short: 'Fund.', category: 'technical' },
							{ name: 'Execution', short: 'Exec.', category: 'technical' },
							{ name: 'Decision Making', short: 'Dec.', category: 'technical' }
						];
						
						const categoryColors = {
							tactical: '#FFD700',
							technical: '#FFE55C',
							physical: '#FFA500',
							social: '#FFED4E'
						};
						
						// Get metric values from the print page
						const values = metricsOrder.map((metric) => {
							const inputId = getInputIdForMetric(metric.name);
							const inputElement = document.getElementById(inputId);
							const score = inputElement ? parseInt(inputElement.value) || 3 : 3;
							return { ...metric, value: score };
						});
						
						// Draw slices
						values.forEach((metric, index) => {
							const startAngle = index * sliceAngle - Math.PI / 2;
							const endAngle = startAngle + sliceAngle;
							const radius = metric.value * radiusScale;
							const color = categoryColors[metric.category];
							
							ctx.beginPath();
							ctx.moveTo(centerX, centerY);
							ctx.arc(centerX, centerY, radius, startAngle, endAngle);
							ctx.lineTo(centerX, centerY);
							ctx.closePath();
							
							ctx.fillStyle = color;
							ctx.fill();
							
							ctx.strokeStyle = '#333333';
							ctx.lineWidth = 0.8;
							ctx.stroke();
						});
						
						// Draw category borders
						const categoryEndIndices = [2, 6, 10, 13];
						const fixedBorderRadius = maxRadius + 5;
						
						categoryEndIndices.forEach((endIndex) => {
							const borderIndex = (endIndex + 1) % 14;
							const angle = (borderIndex * sliceAngle) - Math.PI / 2;
							
							const x1 = centerX + Math.cos(angle) * 2;
							const y1 = centerY + Math.sin(angle) * 2;
							const x2 = centerX + Math.cos(angle) * fixedBorderRadius;
							const y2 = centerY + Math.sin(angle) * fixedBorderRadius;
							
							ctx.strokeStyle = '#333333';
							ctx.lineWidth = 2;
							ctx.beginPath();
							ctx.moveTo(x1, y1);
							ctx.lineTo(x2, y2);
							ctx.stroke();
						});
						
						// Draw metric labels
						ctx.font = 'bold 10px Arial';
						ctx.fillStyle = '#333333';
						ctx.textAlign = 'center';
						ctx.textBaseline = 'middle';
						
						values.forEach((metric, index) => {
							const angle = (index * sliceAngle) + (sliceAngle / 2) - Math.PI / 2;
							const labelRadius = 90;
							const x = centerX + Math.cos(angle) * labelRadius;
							const y = centerY + Math.sin(angle) * labelRadius;
							
							ctx.save();
							ctx.translate(x, y);
							ctx.fillText(metric.short, 0, 0);
							ctx.restore();
						});
						
						// Draw value numbers
						ctx.font = 'bold 10px Arial';
						ctx.fillStyle = '#333333';
						
						values.forEach((metric, index) => {
							const angle = (index * sliceAngle) + (sliceAngle / 2) - Math.PI / 2;
							const radius = 66;
							const x = centerX + Math.cos(angle) * radius;
							const y = centerY + Math.sin(angle) * radius;
							
							ctx.textAlign = 'center';
							ctx.textBaseline = 'middle';
							ctx.fillText(metric.value, x, y);
						});
						
						console.log('✓ Chart rendered successfully in print view');
					}
					
					// Trigger after page loads
					window.addEventListener('load', function() {
						setTimeout(updateRadarChart, 1000);
					});
				}
			<\/script>

		</body>
		</html>`;

				printWindow.document.write(printHTML);
				printWindow.document.close();

				// NEW: After the print content is loaded, fix the attendance bars
				setTimeout(() => {
					if (!printWindow || printWindow.closed) return;

					const bars = printWindow.document.querySelectorAll('.progress-fill');

					// bars[0] = Training Attendance, bars[1] = Match Minutes
					if (bars[0]) {
						bars[0].style.width = trainingAttendancePercentage + '%';
						bars[0].style.background = 'linear-gradient(to right, #FFD700, #E6C200)';
						bars[0].style.height = '10px';
						bars[0].style.borderRadius = '9999px';
					}

					if (bars[1]) {
						bars[1].style.width = matchMinutesPercentage + '%';
						bars[1].style.background = 'linear-gradient(to right, #FFD700, #E6C200)';
						bars[1].style.height = '10px';
						bars[1].style.borderRadius = '9999px';
					}

					console.log('✓ Print progress bars updated:', trainingAttendancePercentage, matchMinutesPercentage);
				}, 300);

				showStatus('Print view opened successfully! The radar chart will appear in a moment.', 'success');

			} catch (error) {
				console.error('Print preparation error:', error);
				showStatus('Failed to prepare print view: ' + error.message, 'error');
			}
		}


		function updateSavedReportsList() {
			const savedReportsList = document.getElementById('saved-reports-list');
			savedReportsList.innerHTML = '';

			if (savedReports.length === 0) {
				savedReportsList.innerHTML = '<li class="text-gray-500 dark:text-gray-300">No saved reports.</li>';
				return;
			}

			savedReports.forEach((report, index) => {
				const li = document.createElement('li');
				li.className = 'flex justify-between items-center p-2 border-b hover:bg-gray-100 dark:hover:bg-gray-700';
				li.innerHTML = `
					<span class="text-sm">${report.name} (${new Date(report.timestamp).toLocaleString()})</span>
					<div>
						<button onclick="viewSavedReport(${index})" class="text-blue-500 hover:text-blue-700 mr-2">View</button>
						<button onclick="deleteSavedReport(${index})" class="text-red-500 hover:text-red-700">Delete</button>
					</div>
				`;
				savedReportsList.appendChild(li);
			});
		}

		function viewSavedReport(index) {
			const report = savedReports[index];
			reportPreview.innerHTML = report.html;
			currentReportHTML = report.html;
			pdfControls.classList.remove('hidden');
			showStatus(`Viewing saved report for ${report.name}`, 'info');
		}

		function deleteSavedReport(index) {
			const reportName = savedReports[index].name;
			savedReports.splice(index, 1);
			updateSavedReportsList();
			showStatus(`Deleted saved report for ${reportName}`, 'success');
		}

		function getCurrentSessionData() {
			const data = selectedPlayerData ? { ...selectedPlayerData } : {};

			if (manualPlayerDataRadio.checked) {
				data['First Name'] = manualFirstName.value || '';
				data['Last Name'] = manualLastName.value || '';
				data['Date of Birth'] = manualDob.value || '';
				data['Position'] = manualPosition.value || '';
			}

			data['Age Group'] = document.getElementById('manual-age-group').value || '';

			data['Height (cm)'] = document.getElementById('player-height').value || '';
			data['Weight (kg)'] = document.getElementById('player-weight').value || '';
			data['10M Sprint (s)'] = document.getElementById('test-10m-sprint').value || '';
			data['30M Sprint (s)'] = document.getElementById('test-30m-sprint').value || '';
			data['CMJ (cm)'] = document.getElementById('test-cmj').value || '';
			data['Yo-Yo IR1'] = document.getElementById('test-yoyo').value || '';

			
			data['Total Training Sessions'] = parseInt(document.getElementById('total-training-sessions').value) || 0;
			data['Training Sessions Attended'] = parseInt(document.getElementById('training-sessions-attended').value) || 0;
			data['Total Training Minutes'] = parseInt(document.getElementById('total-training-minutes').value) || 0;
			data['Total Matches'] = parseInt(document.getElementById('total-matches').value) || 0;
			data['Matches Played'] = parseInt(document.getElementById('matches-played').value) || 0;
			data['Total Match Minutes'] = parseInt(document.getElementById('total-match-minutes').value) || 0;
			data['Match Minutes Played'] = parseInt(document.getElementById('match-minutes-played').value) || 0;

			sliders.forEach(id => {
				const slider = document.getElementById(id);
				const label = id.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
				data[label] = parseInt(slider.value) || 3;
			});

			data['Current Grade'] = document.getElementById('current-grade').value || 'A';
			data['Strengths'] = getCombinedText('strengths') || '';
			data['Coach Feedback'] = getCombinedText('feedback') || '';
			data['Areas of Improvement'] = getCombinedText('improvement') || '';
			data['Short-term Goal'] = getCombinedText('shortgoal') || '';
			data['Long-term Goal'] = getCombinedText('longgoal') || '';


			data['Coach 1 Name'] = document.getElementById('coach1-name').value || 'Melvin Chow';
			data['Coach 1 Title'] = document.getElementById('coach1-title').value || 'Coach';
			data['Coach 2 Name'] = document.getElementById('coach2-name').value || 'Lee Hong Lim';
			data['Coach 2 Title'] = document.getElementById('coach2-title').value || 'Coach';
			data['Technical Director'] = document.getElementById('technical-director').value || 'Tsang Chiu Tat';
			data['Technical Director Title'] = document.getElementById('technical-director-title').value || 'Technical Director';


			return data;
		}

		function downloadAllSessionData() {
		  try {
			if (savedReports.length === 0) {
			  showStatus('No saved reports available to download.', 'error');
			  return;
			}

			// Define v2 template column headers (44 columns in correct order)
			const headers = [
			  'First Name', 'Last Name', 'Date of Birth', 'Position', 'Age Group',
			  'Height (cm)', 'Weight (kg)', '10M Sprint (s)', '30M Sprint (s)', 'CMJ (cm)', 'Yo-Yo IR1',
			  'Total Training Sessions', 'Training Sessions Attended', 'Total Training Minutes',
			  'Total Matches', 'Matches Played', 'Total Match Minutes', 'Match Minutes Played',
			  'Tactical - Attacking', 'Tactical - Defending', 'Tactical - Transition Focus',
			  'Technical - Fundamental', 'Technical - Execution', 'Technical - Decision Making',
			  'Physical - Speed', 'Physical - Agility', 'Physical - Coordination', 'Physical - Endurance',
			  'Social - Communication', 'Social - Confidence', 'Social - Leadership', 'Social - Teamwork',
			  'Current Grade',
			  'Strengths', 'Coach Feedback', 'Areas of Improvement', 'Short-term Goal', 'Long-term Goal',
			  'Coach 1 Name', 'Coach 1 Title', 'Coach 2 Name', 'Coach 2 Title', 'Technical Director', 'Technical Director Title'
			];

			// Prepare data array for XLSX
			const sheetData = [headers];
			
			savedReports.forEach(report => {
				const row = headers.map(header => {
					const value = report.data[header];  // ← Access nested data object
					if (value === undefined || value === null) {
						return '';
					}
					return value;
				});
				sheetData.push(row);
			});

			// Check if XLSX library is available
			if (typeof XLSX === 'undefined') {
			  // Fallback to CSV download
			  downloadSessionDataAsCSV(headers, sheetData, savedReports);
			  return;
			}

			// Create workbook with XLSX
			downloadSessionDataAsExcel(sheetData, headers);
			
			hasDownloadedSessionData = true;
			showStatus(`Downloaded data for ${savedReports.length} reports successfully!`, 'success');

		  } catch (error) {
			console.error('Error downloading session data:', error);
			showStatus('Error downloading session data: ' + error.message, 'error');
		  }
		}

		function downloadSessionDataAsExcel(sheetData, headers) {
		  // Create workbook
		  const wb = XLSX.utils.book_new();
		  
		  // Create worksheet from array of arrays
		  const ws = XLSX.utils.aoa_to_sheet(sheetData);
		  
		  // Set column widths for better readability
		  const colWidths = headers.map(h => {
			if (h.includes('Goal') || h.includes('Feedback')) return 25;
			if (h.includes('Name') || h.includes('Title')) return 20;
			if (h.includes('Strengths') || h.includes('Improvement')) return 25;
			if (h.includes('Coach')) return 20;
			return 12;
		  });
		  ws['!cols'] = colWidths.map(w => ({ wch: w }));
		  
		  // Add worksheet to workbook
		  XLSX.utils.book_append_sheet(wb, ws, 'Players');
		  
		  // Generate filename with timestamp
		  const timestamp = new Date().toISOString().slice(0, 10);
		  const filename = `lee_man_player_data_${timestamp}.xlsx`;
		  
		  // Write file
		  XLSX.writeFile(wb, filename);
		}

		function downloadSessionDataAsCSV(headers, sheetData, reports) {
		  // Build CSV content
		  let csvContent = headers.map(h => `"${h}"`).join(',') + '\n';
		  
		  // Add each report row
		  sheetData.slice(1).forEach(row => {
			const csvRow = row.map(cell => {
			  if (cell === undefined || cell === null) {
				return '';
			  }
			  // Escape quotes in text fields
			  const stringValue = String(cell).replace(/"/g, '""');
			  return `"${stringValue}"`;
			}).join(',');
			
			csvContent += csvRow + '\n';
		  });
		  
		  // Create blob and download
		  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
		  const link = document.createElement('a');
		  const url = URL.createObjectURL(blob);
		  
		  link.setAttribute('href', url);
		  link.setAttribute('download', `lee_man_player_data_${new Date().toISOString().slice(0, 10)}.csv`);
		  link.style.visibility = 'hidden';
		  
		  document.body.appendChild(link);
		  link.click();
		  document.body.removeChild(link);
		}


		function handleBeforeUnload(event) {
			if (savedReports.length > 0 && !hasDownloadedSessionData) {
				const message = 'You have unsaved session data. Please download it before closing the window to avoid losing your work.';
				event.preventDefault();
				event.returnValue = message;
				return message;
			}
		}

		function updateBeforeUnloadListener() {
			window.removeEventListener('beforeunload', handleBeforeUnload);
			if (savedReports.length > 0 && !hasDownloadedSessionData) {
				window.addEventListener('beforeunload', handleBeforeUnload);
			}
		}

		// Add this before DOMContentLoaded, after your other function definitions
		function resetCropper() {
				if (cropper) {
					cropper.destroy();
					cropper = null;
				}
				document.getElementById('cropperContainer').style.display = 'none';
				document.getElementById('croppedImage').style.display = 'none';
				document.getElementById('portraitFile').value = '';
				portraitImageData = null;
				updateGenerateButtonState();
				updateProgress();
			}

		function handlePortraitUpload(e) {
			const file = e.target.files[0];
			if (file) {
				const reader = new FileReader();
				reader.onload = function(event) {
					portraitImageData = event.target.result; // Store original image
					const imgElement = document.getElementById('imageToCrop');
					imgElement.src = event.target.result;
					document.getElementById('cropperContainer').style.display = 'block';
					document.getElementById('croppedImage').style.display = 'none';

					if (cropper) {
						cropper.destroy();
					}

					cropper = new Cropper(imgElement, {
						aspectRatio: 1,
						viewMode: 1,
						autoCropArea: 0.8,
						cropBoxResizable: true,
						cropBoxMovable: true,
						dragMode: 'move',
						background: false,
						crop(event) {}
					});
					const cropBox = document.querySelector('.cropper-crop-box');
					if (cropBox) {
						cropBox.style.borderRadius = '50%';
						cropBox.style.overflow = 'hidden';
					}
					updateGenerateButtonState();
					updateProgress();
				};
				reader.readAsDataURL(file);
			}
		}

		document.getElementById('cropButton').addEventListener('click', function() {
			if (cropper) {
				const canvas = cropper.getCroppedCanvas({
					width: 200,
					height: 200
				});
				portraitImageData = canvas.toDataURL('image/jpeg');
				document.getElementById('croppedImage').src = portraitImageData;
				document.getElementById('croppedImage').style.display = 'block';
				document.getElementById('cropperContainer').style.display = 'none';
				cropper.destroy();
				cropper = null;
				showStatus('Player portrait cropped and uploaded successfully!', 'success');
				updateGenerateButtonState();
				updateProgress();
			}
		});

		document.getElementById('cancelCropButton').addEventListener('click', function() {
			resetCropper();
			showStatus('Portrait upload cancelled.', 'info');
			updateGenerateButtonState();
			updateProgress();
		});



		// DOMContentLoaded block with all event listeners
		document.addEventListener('DOMContentLoaded', () => {
		// Initialize tag-based selectors
		initializeTagSelectors();

			// Collapsible headers
			document.querySelectorAll('.collapsible-header').forEach(header => {
				header.addEventListener('click', () => toggleSection(header));
			});

			// Set "Form Progress" to be collapsed by default
			const progressHeader = document.querySelector('#progress-tracker .collapsible-header');
			const progressContent = document.querySelector('#progress-details');
			if (progressHeader && progressContent) {
				progressHeader.classList.remove('active');
				progressContent.classList.remove('active');
			}

			// Player input method toggle
			manualPlayerDataRadio.addEventListener('change', togglePlayerInput);
			filePlayerDataRadio.addEventListener('change', togglePlayerInput);

			// File uploads
			xlsFileInput.addEventListener('change', handleFileUpload);
			portraitFileInput.addEventListener('change', handlePortraitUpload);
			clubLogoFileInput.addEventListener('change', handleClubLogoUpload);

			// Form controls
			manualFirstName.addEventListener('input', () => {
				updateGenerateButtonState();
				updateProgress();
			});
			manualLastName.addEventListener('input', () => {
				updateGenerateButtonState();
				updateProgress();
			});

			

			playerSelect.addEventListener('change', () => {
			  const index = playerSelect.value;
			  selectedPlayerData = index ? playersData[index] : null;
			  
			  if (selectedPlayerData) {
				console.log('Player selected:', selectedPlayerData);
				
				// Reset tracking
				templateColumnsFound = [];
				templateColumnsMissing = [];
				
				// === Basic Player Information ===
				document.getElementById('manual-first-name').value = selectedPlayerData['First Name'] || '';
				document.getElementById('manual-last-name').value = selectedPlayerData['Last Name'] || '';
				document.getElementById('manual-dob').value = selectedPlayerData['Date of Birth'] || '';
				document.getElementById('manual-position').value = selectedPlayerData['Position'] || '';
				
				const ageGroupSelect = document.getElementById('manual-age-group');
				if (ageGroupSelect && selectedPlayerData['Age Group']) {
				  ageGroupSelect.value = selectedPlayerData['Age Group'];
				}
				
				// Track basic info
				if (selectedPlayerData['First Name']) templateColumnsFound.push('First Name');
				if (selectedPlayerData['Last Name']) templateColumnsFound.push('Last Name');
				if (selectedPlayerData['Date of Birth']) templateColumnsFound.push('Date of Birth');
				if (selectedPlayerData['Position']) templateColumnsFound.push('Position');
				if (selectedPlayerData['Age Group']) templateColumnsFound.push('Age Group');
				
				// === Attendance Data ===
				document.getElementById('total-training-sessions').value = selectedPlayerData['Total Training Sessions'] || 0;
				document.getElementById('training-sessions-attended').value = selectedPlayerData['Training Sessions Attended'] || 0;
				document.getElementById('total-training-minutes').value = selectedPlayerData['Total Training Minutes'] || 0;
				document.getElementById('total-matches').value = selectedPlayerData['Total Matches'] || 0;
				document.getElementById('matches-played').value = selectedPlayerData['Matches Played'] || 0;
				document.getElementById('total-match-minutes').value = selectedPlayerData['Total Match Minutes'] || 0;
				document.getElementById('match-minutes-played').value = selectedPlayerData['Match Minutes Played'] || 0;
				
				// Track attendance
				if (selectedPlayerData['Total Training Sessions'] !== undefined) templateColumnsFound.push('Total Training Sessions');
				if (selectedPlayerData['Training Sessions Attended'] !== undefined) templateColumnsFound.push('Training Sessions Attended');
				if (selectedPlayerData['Total Training Minutes'] !== undefined) templateColumnsFound.push('Total Training Minutes');
				if (selectedPlayerData['Total Matches'] !== undefined) templateColumnsFound.push('Total Matches');
				if (selectedPlayerData['Matches Played'] !== undefined) templateColumnsFound.push('Matches Played');
				if (selectedPlayerData['Total Match Minutes'] !== undefined) templateColumnsFound.push('Total Match Minutes');
				if (selectedPlayerData['Match Minutes Played'] !== undefined) templateColumnsFound.push('Match Minutes Played');
				
				// === Performance Ratings ===
				Object.entries(EXCEL_COLUMN_MAPPING).forEach(([excelColumn, fieldId]) => {
				  if (fieldId.startsWith('tactical-') || 
					  fieldId.startsWith('technical-') || 
					  fieldId.startsWith('physical-') || 
					  fieldId.startsWith('social-')) {
					
					const element = document.getElementById(fieldId);
					if (element && selectedPlayerData[excelColumn] !== undefined) {
					  const value = parseInt(selectedPlayerData[excelColumn]);
					  
					  if (!isNaN(value) && value >= 1 && value <= 5) {
						element.value = value;
						const valueDisplay = element.parentElement.querySelector('.rating-value');
						if (valueDisplay) {
						  valueDisplay.textContent = value;
						}
						templateColumnsFound.push(excelColumn);
					  }
					}
				  }
				});
				
				// === Physical Measurements ===
				Object.entries(EXCEL_COLUMN_MAPPING).forEach(([excelColumn, fieldId]) => {
				  if (fieldId === 'player-height' || fieldId === 'player-weight' || fieldId.startsWith('test-')) {
					const element = document.getElementById(fieldId);
					if (element && selectedPlayerData[excelColumn] !== undefined) {
					  element.value = selectedPlayerData[excelColumn];
					  templateColumnsFound.push(excelColumn);
					}
				  }
				});
				
				// === Grade ===
				const currentGrade = document.getElementById('current-grade');
				if (currentGrade && selectedPlayerData['Current Grade']) {
				  currentGrade.value = selectedPlayerData['Current Grade'];
				  templateColumnsFound.push('Current Grade');
				}
				
				// === Feedback & Goals ===
				['Strengths', 'Coach Feedback', 'Short-term Goal', 'Long-term Goal', 'Areas of Improvement'].forEach(field => {
				  const fieldId = EXCEL_COLUMN_MAPPING[field];
				  const element = document.getElementById(fieldId);
				  if (element && selectedPlayerData[field]) {
					element.value = selectedPlayerData[field];
					templateColumnsFound.push(field);
				  }
				});
				
				// === Signatures ===
				document.getElementById('coach1-name').value = selectedPlayerData['Coach 1 Name'] || 'Melvin Chow';
				document.getElementById('coach1-title').value = selectedPlayerData['Coach 1 Title'] || 'Coach';
				document.getElementById('coach2-name').value = selectedPlayerData['Coach 2 Name'] || 'Lee Hong Lim';
				document.getElementById('coach2-title').value = selectedPlayerData['Coach 2 Title'] || 'Coach';
				document.getElementById('technical-director').value = selectedPlayerData['Technical Director'] || 'Tsang Chiu Tat';
				document.getElementById('technical-director-title').value = selectedPlayerData['Technical Director Title'] || 'Technical Director';
				
				// Track signatures
				if (selectedPlayerData['Coach 1 Name']) templateColumnsFound.push('Coach 1 Name');
				if (selectedPlayerData['Coach 1 Title']) templateColumnsFound.push('Coach 1 Title');
				if (selectedPlayerData['Coach 2 Name']) templateColumnsFound.push('Coach 2 Name');
				if (selectedPlayerData['Coach 2 Title']) templateColumnsFound.push('Coach 2 Title');
				if (selectedPlayerData['Technical Director']) templateColumnsFound.push('Technical Director');
				if (selectedPlayerData['Technical Director Title']) templateColumnsFound.push('Technical Director Title');
				
				// Update UI
				updateMetricAverages();
				updateProgress();
				
				// === Show Template Compatibility Report ===
				console.log('Template Compatibility Report:');
				console.log('- Columns found:', templateColumnsFound.length);
				console.log('- Expected: 44');
				console.log('- Columns loaded:', [...new Set(templateColumnsFound)].length); // Unique count
				
				if (templateColumnsFound.length === 44) {
				  showStatus('Player data loaded successfully! All 44 fields mapped.', 'success');
				} else {
				  showStatus(`Only ${templateColumnsFound.length}/44 fields loaded. Check template columns.`, 'warning');
				}
				
				ratingsLoadedFromFile = true;
				
			  } else {
				resetForm();
			  }
			});


			
			// Sliders
			sliders.forEach(id => {
				const slider = document.getElementById(id);
				if (slider) {
					slider.addEventListener('input', () => {
						const valueDisplay = slider.parentElement.querySelector('.rating-value');
						if (valueDisplay) {
							valueDisplay.textContent = slider.value;
						}
						ratingsManuallyChanged.add(id);
						updateMetricAverages(); // Update category averages
						updateProgress();
					});
				}
			});

			// Height and attendance inputs

			

			document.querySelectorAll('#attendance-manual-input input[type="number"]').forEach(input => {
				input.addEventListener('input', updateProgress);
			});

			// Feedback and signatures
			document.getElementById('current-grade').addEventListener('change', updateProgress);
			document.getElementById('coach1-name').addEventListener('input', updateProgress);
			document.getElementById('coach2-name').addEventListener('input', updateProgress);
			document.getElementById('technical-director').addEventListener('input', updateProgress);

			// Buttons
			generateBtn.addEventListener('click', generateReport);
			resetBtn.addEventListener('click', resetForm);
			printBtn.addEventListener('click', preparePrintView);
			document.getElementById('download-session-btn').addEventListener('click', downloadAllSessionData);

			// Saved reports interaction
			document.addEventListener('click', (e) => {
				if (e.target.matches('button[onclick^="viewSavedReport"]')) {
					const index = parseInt(e.target.getAttribute('onclick').match(/\d+/)[0]);
					viewSavedReport(index);
				} else if (e.target.matches('button[onclick^="deleteSavedReport"]')) {
					const index = parseInt(e.target.getAttribute('onclick').match(/\d+/)[0]);
					deleteSavedReport(index);
				}
			});

			// Beforeunload handling
			const originalGenerateReport = generateReport;
			generateReport = function() {
				originalGenerateReport();
				updateBeforeUnloadListener();
			};
			const originalDownloadAllSessionData = downloadAllSessionData;
			downloadAllSessionData = function() {
				originalDownloadAllSessionData();
				updateBeforeUnloadListener();
			};
			const originalUpdateSavedReportsList = updateSavedReportsList;
			updateSavedReportsList = function() {
				originalUpdateSavedReportsList();
				updateBeforeUnloadListener();
			};
			updateBeforeUnloadListener();




					


					if (positionInput) positionInput.addEventListener('change', updateContextTags);
					if (ageGroupSelect) ageGroupSelect.addEventListener('change', updateContextTags);

					// Initialise once (in case player is loaded from file)
					updateContextTags();


			// Initial setup
			togglePlayerInput();
			
			updateGenerateButtonState();
			updateProgress();
		});
			
	</script>
	<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'925c0a02f8251fc2',t:'MTc0Mjg4MDg2Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();
	</script>
	</html>